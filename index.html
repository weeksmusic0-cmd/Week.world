<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Week.world - Pro Edition PC</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<style>
    body{margin:0;font-family:'Segoe UI',Arial;overflow:hidden; background: #000; color: white;}
    #map{height:100vh; width:100%; cursor:crosshair; background: #222; position: absolute; top:0; left:0; z-index: 1;}

    /* MEN√ú VE EKRANLAR */
    #main-menu, #challenge-menu, #profile-edit-menu, #market-menu {
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: #050505; z-index: 9999;
        display: flex; justify-content: space-between; align-items: center;
        transition: opacity 0.5s ease;
    }
    #challenge-menu, #profile-edit-menu, #market-menu { display: none; flex-direction: column; justify-content: center; z-index: 10001; }

    /* GERƒ∞ SAYIM ANƒ∞MASYONU */
    #start-countdown-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, #1a1a1a 0%, #000 100%); z-index: 20000;
        display: none; flex-direction: column; align-items: center; justify-content: center;
        text-align: center;
    }
    .fade-zoom-in { animation: zoomIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    .slide-up-out { animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    @keyframes zoomIn { from { opacity: 0; transform: scale(1.1); } to { opacity: 1; transform: scale(1); } }
    @keyframes slideUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
    .countdown-number { font-size: 12rem; font-weight: 900; color: white; animation: pulseNumber 1s infinite; }
    @keyframes pulseNumber { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 1; } }

    /* MARKET STƒ∞LLERƒ∞ */
    .market-header { position: absolute; top: 30px; right: 50px; display: flex; align-items: center; gap: 15px; font-size: 24px; font-weight: bold; color: #ffcc00; }
    .market-container { width: 90%; max-height: 85vh; overflow-y: auto; padding: 20px; text-align: center; }
    .market-section-title { font-size: 1.8rem; color: #ffcc00; margin: 40px 0 20px 0; border-bottom: 2px solid #333; padding-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
    .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; margin-bottom: 50px; }
    .market-item { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 20px; padding: 20px; transition: 0.3s; }
    .market-item:hover { border-color: #2962ff; background: rgba(255,255,255,0.08); }
    .item-img-preview { width: 80px; height: 80px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #444; object-fit: cover; }
    .frame-preview { border-radius: 50%; border: 4px solid; }
    .item-name { font-weight: bold; margin-bottom: 5px; font-size: 14px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .item-price { color: #ffcc00; font-size: 18px; font-weight: bold; margin-bottom: 15px; }
    .buy-btn { background: #2962ff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
    .buy-btn:hover { background: #0039cb; }
    .buy-btn.owned { background: #444; cursor: default; }

    /* LOBƒ∞ PAR√áALARI */
    .center-stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; z-index: 10000; }
    .game-title { color: white; font-size: 4.5rem; margin: 0 0 10px 0; letter-spacing: -2px; pointer-events: none; }
    #world-3d-container { width: 380px; height: 380px; cursor: grab; }
    #world-3d-container:active { cursor: grabbing; }
    .side-menu-left { display: flex; flex-direction: column; gap: 20px; margin-left: 50px; z-index: 10000; }
    .mode-card { width: 260px; height: 110px; background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 15px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.4s; position: relative; overflow: hidden; }
    .mode-card:hover { border-color: #ffcc00; transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); }
    .mode-title { font-size: 1.1rem; font-weight: bold; text-align: center; transition: 0.3s; }
    .mode-desc { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 85%; font-size: 0.85rem; color: #ffcc00; opacity: 0; transition: 0.3s; pointer-events: none; }
    .mode-card:hover .mode-title { opacity: 0; }
    .mode-card:hover .mode-desc { opacity: 1; }

    .side-menu-right { position: absolute; top: 25px; right: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 10000; }
    .panel-box { background: rgba(20, 25, 35, 0.9); padding: 15px 20px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); width: 260px; }
    
    /* PROFƒ∞L Sƒ∞STEMƒ∞ */
    .mini-profile { cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
    .mini-profile:hover { border-color: #2962ff; background: rgba(41, 98, 255, 0.1); }
    .mini-profile:hover::after {
        content: "PROFƒ∞Lƒ∞ D√úZENLE"; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
        font-size: 16px; font-weight: bold; color: #ffcc00; backdrop-filter: blur(2px);
    }

    .avatar-wrapper { width: 64px; height: 64px; position: relative; display: flex; align-items: center; justify-content: center; }
    .avatar-img { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; background: #333; z-index: 1; }
    .avatar-frame { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; pointer-events: none; z-index: 2; box-sizing: border-box; }
    
    /* ENVANTER */
    .inventory-section { background: rgba(0,0,0,0.5); border-radius: 15px; padding: 15px; margin-bottom: 20px; text-align: left; border: 1px solid #333; }
    .inventory-title { color: #888; font-size: 12px; margin-bottom: 10px; font-weight: bold; text-transform: uppercase;}
    .inventory-grid { display: flex; gap: 15px; flex-wrap: wrap; }
    .inv-item { transition: 0.2s; }
    .inv-item:hover { transform: scale(1.1); }

    /* √úNVAN ETƒ∞KETƒ∞ */
    .title-tag { background: #222; border: 1px solid #444; color: #eee; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: 0.2s; }
    .title-tag:hover { background: #333; border-color: #ffcc00; }
    .title-tag.active { background: #ffcc00; color: #000; font-weight: bold; border-color: #ffcc00; }

    /* OYUN UI */
    .top-bar{ position:absolute;top:20px;left:0;width:100%; display:flex;justify-content:space-between;padding:0 30px;box-sizing:border-box;z-index:1000; visibility: hidden; pointer-events: none; }
    .city-box{background:#ffcc00;padding:12px 25px;border-radius:12px;font-weight:bold; color:black; font-size: 20px; pointer-events: auto;}
    .score-box{background:#00c853;color:white;padding:12px 25px;border-radius:12px;font-weight:bold; min-width:140px; text-align:center; pointer-events: auto;}
    .timer-box{ position:absolute;top:20px;left:50%;transform:translateX(-50%); background:#ff3d00;color:white;padding:12px 30px;border-radius:20px; font-weight:bold; font-size: 22px; z-index:1000; visibility: hidden;}
    .distance-box{ position:absolute;top:85px;left:50%;transform:translateX(-50%); background:#2962ff;color:white;padding:10px 25px;border-radius:20px; font-weight:bold;z-index:1000;display:none; }
    .bottom-bar{ position:absolute;bottom:40px;left:50%;transform:translateX(-50%); z-index:1000; visibility: hidden;}
    .guess-btn { padding:16px 60px;font-size:20px;border-radius:40px; background:#2962ff;color:white;cursor:pointer;font-weight:bold; border:none; opacity: 0.4; pointer-events: none; transition: 0.3s; }
    .guess-btn.active { opacity: 1; pointer-events: auto; }
    .result-box{ position:fixed;top:50%;left:50%;transform:translate(-50%,-50%); background:white;padding:40px;border-radius:24px; z-index:10001; display:none; text-align:center; color: black; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    .back-btn { padding: 12px 30px; background: rgba(255,255,255,0.1); color: white; border-radius: 10px; cursor: pointer; border: 1px solid #444; font-weight: bold;}
    .back-btn:hover { background: #ff3d00; border-color: #ff3d00; }
    .win-bar { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; display: flex; gap: 2px; padding: 2px; }
    .tick { flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px; }
    .tick.active { background: #ffcc00; box-shadow: 0 0 5px #ffcc00;}
</style>
</head>
<body>

<div id="start-countdown-overlay">
    <div style="font-size: 2.5rem; font-weight: 800; color: #ffcc00; margin-bottom: 20px;">OYUNUN BA≈ûLAMASINA</div>
    <div id="countdown-num" class="countdown-number">5</div>
</div>

<div id="main-menu">
    <div class="side-menu-left">
        <div class="mode-card" onclick="startCountdown('normal')">
            <span class="mode-title">üåç D√úNYA MODU</span>
            <span class="mode-desc">Klasik deneyim. Hedef 25.000 puan.</span>
        </div>
        <div class="mode-card" onclick="startCountdown('speedrun')">
            <span class="mode-title">‚è±Ô∏è S√úRELƒ∞ MOD</span>
            <span class="mode-desc">500km altƒ±na inersen s√ºre 1 dakikaya sƒ±fƒ±rlanƒ±r!</span>
        </div>
        <div class="mode-card" onclick="startCountdown('hardcore')">
            <span class="mode-title">üß≠ ZOR MOD</span>
            <span class="mode-desc">Hata payƒ± yok (500km sƒ±nƒ±r).</span>
        </div>
        <div class="mode-card" onclick="openChallenges()">
            <span class="mode-title">üìö MEYDAN OKUMALAR</span>
            <span class="mode-desc">√ñzel √∂d√ºller ve madalyalar kazan.</span>
        </div>
    </div>

    <div class="center-stage">
        <h1 class="game-title">Week.world</h1>
        <div id="world-3d-container"></div>
    </div>

    <div class="side-menu-right">
        <div class="panel-box mini-profile" onclick="openProfileEdit()">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="avatar-wrapper">
                    <img src="" id="display-avatar" class="avatar-img">
                    <div id="display-frame" class="avatar-frame"></div>
                </div>
                <div>
                    <div id="display-name" style="font-weight:bold;">Oyuncu</div>
                    <div id="display-title" style="font-size:10px; color:#ffcc00;">YENƒ∞ OYUNCU</div>
                </div>
            </div>
        </div>
        <div class="panel-box">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                <span id="rank-emoji" style="font-size:36px;">‚õìÔ∏è</span>
                <div>
                    <div style="font-size: 10px; color: #888;">RANK</div>
                    <div id="rank-name" style="font-weight:bold;">Demir</div>
                </div>
            </div>
            <div class="win-bar" id="win-ticks"></div>
        </div>
        <div class="panel-box">
            <div style="font-size: 10px; color: #888;">TOPLAM OYNAMA S√úRESƒ∞</div>
            <div id="playtime-display" style="font-size: 14px; font-weight: bold; color: #ffcc00; margin-top: 5px;">0 G√ºn 0 Saat 0 Dakika</div>
        </div>
        <button class="buy-btn" style="height:50px; font-size:16px; background: linear-gradient(45deg, #6200ea, #2962ff);" onclick="openMarket()">üõí MARKET</button>
    </div>
</div>

<div id="market-menu">
    <div class="market-header">üèÜ <span id="market-medal-count">0</span></div>
    <div class="market-container">
        <h2 class="market-section-title">üñºÔ∏è Profil Fotoƒüraflarƒ±</h2>
        <div class="market-grid" id="market-grid-photos"></div>

        <h2 class="market-section-title">‚ú® Avatar √áer√ßeveleri</h2>
        <div class="market-grid" id="market-grid-frames"></div>

        <h2 class="market-section-title">üéñÔ∏è √únvanlar</h2>
        <div class="market-grid" id="market-grid-titles"></div>
    </div>
    <button class="back-btn" style="position: absolute; bottom: 40px; left: 40px;" onclick="closeMarket()">‚Üê GERƒ∞ D√ñN</button>
</div>

<div id="challenge-menu">
    <h2 style="font-size: 3rem;">Meydan Okumalar</h2>
    <div style="display:flex; gap:20px; margin-top: 20px;">
        <div class="mode-card" onclick="startCountdown('total_time')">
            <span class="mode-title">‚è≥ TOPLAM S√úRE</span>
            <span class="mode-desc">25.000 puan i√ßin toplam 2 dakikan var!</span>
        </div>
        <div class="mode-card" onclick="startCountdown('blind_shot')">
            <span class="mode-title">üåë K√ñR ATI≈û</span>
            <span class="mode-desc">Sƒ±nƒ±rsƒ±z harita, 500km sƒ±nƒ±r ve 3 dk!</span>
        </div>
    </div>
    <div class="panel-box" style="margin-top:40px; width: auto; padding: 15px 40px; text-align: center;">
        üèÜ MADALYALAR: <span id="challenge-medal-count" style="font-weight:bold; color:#ffcc00; font-size: 24px;">0</span>
    </div>
    <button class="back-btn" style="position: absolute; bottom: 40px; left: 40px;" onclick="closeChallenges()">‚Üê GERƒ∞</button>
</div>

<div id="profile-edit-menu" style="background: rgba(15, 15, 20, 0.95); border: 1px solid #333; width: 700px; padding: 40px; border-radius: 20px; text-align: center; margin: auto; max-height: 80vh; overflow-y: auto;">
    <h2 style="margin-top: 0; color: #ffcc00;">Profil ve Envanter</h2>
    <div style="margin-bottom: 30px;">
        <div class="inventory-title">KULLANICI ADI</div>
        <input type="text" id="name-input" placeholder="ƒ∞sim Deƒüi≈ütir" style="padding:15px; border-radius:10px; border: 1px solid #444; background: rgba(0,0,0,0.5); color: white; width:80%; font-size: 16px; text-align: center;">
    </div>
    <div class="inventory-section">
        <div class="inventory-title">SAHƒ∞P OLUNAN √úNVANLAR (Ku≈üanmak ƒ∞√ßin Tƒ±kla)</div>
        <div class="inventory-grid" id="inv-titles" style="justify-content: center;"></div>
    </div>
    <div class="inventory-section">
        <div class="inventory-title">SAHƒ∞P OLUNAN AVATARLAR</div>
        <div class="inventory-grid" id="inv-avatars"></div>
    </div>
    <div class="inventory-section">
        <div class="inventory-title">SAHƒ∞P OLUNAN √áER√áEVELER</div>
        <div class="inventory-grid" id="inv-frames"></div>
    </div>
    <button class="back-btn" style="margin-top: 20px; width: 200px; background: #2962ff; border: none;" onclick="closeProfileEdit()">KAYDET VE √áIK</button>
</div>

<div class="top-bar" id="game-top-bar">
    <div class="city-box">Hedef: <span id="cityName">≈ûehir</span></div>
    <div class="score-box">Puan: <span id="score">0</span></div>
</div>
<div class="timer-box" id="timer">02:00</div>
<div class="distance-box" id="distanceBox"></div>
<div class="bottom-bar" id="game-bottom-bar">
    <button class="guess-btn" id="guessBtn" onclick="makeGuess()">TAHMƒ∞N ET</button>
</div>
<div class="result-box" id="result"></div>
<div id="map"></div>

<script>
/* --- VERƒ∞ Sƒ∞STEMƒ∞ --- */
let wins = parseInt(localStorage.getItem('weekWorldWins')) || 0;
let medals = parseInt(localStorage.getItem('weekWorldMedals')) || 0;
let totalSeconds = parseInt(localStorage.getItem('weekWorldPlaytime')) || 0;

let profileData = JSON.parse(localStorage.getItem('weekWorldProfile')) || {
    name: "Oyuncu",
    title: "YENƒ∞ OYUNCU",
    avatar: "https://i.ibb.co/vz6mXmX/default-avatar.png",
    frame: "",
    ownedAvatars: ["https://i.ibb.co/vz6mXmX/default-avatar.png"],
    ownedFrames: [],
    ownedTitles: ["YENƒ∞ OYUNCU", "GEZGƒ∞N"]
};

/* --- S√úRE Sƒ∞STEMƒ∞ --- */
setInterval(() => {
    totalSeconds++;
    localStorage.setItem('weekWorldPlaytime', totalSeconds);
    let d = Math.floor(totalSeconds / 86400), h = Math.floor((totalSeconds % 86400) / 3600), m = Math.floor((totalSeconds % 3600) / 60);
    document.getElementById('playtime-display').innerText = `${d} G√ºn ${h} Saat ${m} Dakika`;
}, 1000);

/* --- MARKET VERƒ∞LERƒ∞ --- */
const createSVG = (color, text) => `data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect width='150' height='150' fill='%23${color}'/%3E%3Ctext x='50%25' y='50%25' font-size='24' fill='white' font-family='Arial' font-weight='bold' text-anchor='middle' dy='.3em'%3E${text}%3C/text%3E%3C/svg%3E`;

const coloredProducts = [
    { id: 'p_blue', type: 'photo', name: 'Mavi Profil Fotoƒürafƒ±', price: 8, url: createSVG('2962ff', 'Mavi') },
    { id: 'p_green', type: 'photo', name: 'Ye≈üil Profil Fotoƒürafƒ±', price: 8, url: createSVG('00c853', 'Ye≈üil') },
    { id: 'p_red', type: 'photo', name: 'Kƒ±rmƒ±zƒ± Profil Fotoƒürafƒ±', price: 8, url: createSVG('ff3d00', 'Kƒ±rmƒ±zƒ±') },
    { id: 'f_blue', type: 'frame', name: 'Mavi Avatar √áer√ßevesi', price: 10, color: '#2962ff' },
    { id: 'f_green', type: 'frame', name: 'Ye≈üil Avatar √áer√ßevesi', price: 10, color: '#00c853' },
    { id: 'f_red', type: 'frame', name: 'Kƒ±rmƒ±zƒ± Avatar √áer√ßevesi', price: 10, color: '#ff3d00' },
    { id: 't_rich', type: 'title', name: 'Zengin Oyuncu', price: 15, titleColor: '#ccff00' },
    { id: 't_first', type: 'title', name: 'Birinci', price: 8, titleColor: '#00ffff' }
];

function initMarket() {
    const photoGrid = document.getElementById('market-grid-photos');
    const frameGrid = document.getElementById('market-grid-frames');
    const titleGrid = document.getElementById('market-grid-titles');
    photoGrid.innerHTML = ''; frameGrid.innerHTML = ''; titleGrid.innerHTML = '';

    coloredProducts.forEach(product => {
        let isOwned = false;
        if(product.type === 'photo') isOwned = profileData.ownedAvatars.includes(product.url);
        else if(product.type === 'frame') isOwned = profileData.ownedFrames.includes(product.color);
        else if(product.type === 'title') isOwned = profileData.ownedTitles.includes(product.name);

        const itemDiv = document.createElement('div');
        itemDiv.className = 'market-item';
        let previewHTML = "";
        if(product.type === 'frame') previewHTML = `<div class="item-img-preview frame-preview" style="border-color: ${product.color}; margin-left:auto; margin-right:auto;"></div>`;
        else if(product.type === 'photo') previewHTML = `<img src="${product.url}" class="item-img-preview" style="margin-left:auto; margin-right:auto;">`;
        else if(product.type === 'title') previewHTML = `<div style="color:${product.titleColor}; font-weight:bold; font-size:1.2rem; margin-bottom:15px; height:80px; display:flex; align-items:center; justify-content:center;">${product.name}</div>`;

        itemDiv.innerHTML = `${previewHTML}<div class="item-name">${product.type === 'title' ? '' : product.name}</div><div class="item-price">üèÜ ${product.price}</div><button class="buy-btn ${isOwned ? 'owned' : ''}" onclick="buyProduct('${product.id}')">${isOwned ? 'SAHƒ∞PSƒ∞N' : 'SATIN AL'}</button>`;
        if(product.type === 'photo') photoGrid.appendChild(itemDiv);
        else if(product.type === 'frame') frameGrid.appendChild(itemDiv);
        else if(product.type === 'title') titleGrid.appendChild(itemDiv);
    });
}

function buyProduct(productId) {
    const product = coloredProducts.find(p => p.id === productId);
    let isOwned = false;
    if(product.type === 'photo') isOwned = profileData.ownedAvatars.includes(product.url);
    else if(product.type === 'frame') isOwned = profileData.ownedFrames.includes(product.color);
    else if(product.type === 'title') isOwned = profileData.ownedTitles.includes(product.name);
    if(isOwned) return;

    if(medals >= product.price) {
        medals -= product.price;
        if(product.type === 'photo') { profileData.ownedAvatars.push(product.url); profileData.avatar = product.url; } 
        else if(product.type === 'frame') { profileData.ownedFrames.push(product.color); profileData.frame = product.color; }
        else if(product.type === 'title') { profileData.ownedTitles.push(product.name); profileData.title = product.name; }
        localStorage.setItem('weekWorldMedals', medals);
        saveProfile(); updateUI(); renderInventory(); initMarket();
    }
}

/* --- ENVANTER --- */
function renderInventory() {
    const avGrid = document.getElementById('inv-avatars'), frGrid = document.getElementById('inv-frames'), tiGrid = document.getElementById('inv-titles');
    avGrid.innerHTML = ''; frGrid.innerHTML = ''; tiGrid.innerHTML = '';

    profileData.ownedTitles.forEach(t => {
        const span = document.createElement('div');
        span.className = `title-tag ${profileData.title === t ? 'active' : ''}`;
        span.innerText = t; span.onclick = () => { profileData.title = t; renderInventory(); updateUI(); };
        tiGrid.appendChild(span);
    });
    profileData.ownedAvatars.forEach(url => {
        let img = document.createElement('img'); img.src = url; img.className = 'inv-item';
        img.style.cssText = `width:60px; height:60px; border-radius:50%; cursor:pointer; border: 3px solid ${profileData.avatar === url ? '#ffcc00' : 'transparent'};`;
        img.onclick = () => { profileData.avatar = url; updateUI(); renderInventory(); };
        avGrid.appendChild(img);
    });
    let noFrame = document.createElement('div'); noFrame.className = 'inv-item';
    noFrame.style.cssText = `width:54px; height:54px; border-radius:50%; cursor:pointer; border: 3px solid ${profileData.frame === '' ? '#ffcc00' : '#444'}; display:flex; align-items:center; justify-content:center; font-size: 20px; background: rgba(0,0,0,0.5);`;
    noFrame.innerHTML = '‚ùå'; noFrame.onclick = () => { profileData.frame = ''; updateUI(); renderInventory(); };
    frGrid.appendChild(noFrame);

    profileData.ownedFrames.forEach(color => {
        let div = document.createElement('div'); div.className = 'inv-item';
        div.style.cssText = `width:54px; height:54px; border-radius:50%; cursor:pointer; border: 4px solid ${color}; box-shadow: ${profileData.frame === color ? '0 0 15px ' + color : 'none'};`;
        div.onclick = () => { profileData.frame = color; updateUI(); renderInventory(); };
        frGrid.appendChild(div);
    });
}

function updateUI() {
    if(wins >= 60 && !profileData.ownedTitles.includes("Altƒ±n Oyuncu")) { profileData.ownedTitles.push("Altƒ±n Oyuncu"); saveProfile(); }
    document.getElementById('market-medal-count').innerText = medals;
    document.getElementById('challenge-medal-count').innerText = medals;
    document.getElementById('display-name').innerText = profileData.name;
    document.getElementById('display-avatar').src = profileData.avatar;
    document.getElementById('display-frame').style.border = profileData.frame ? `4px solid ${profileData.frame}` : 'none';
    document.getElementById('display-title').innerText = profileData.title;
    document.getElementById('name-input').value = profileData.name;
    
    const ticksContainer = document.getElementById('win-ticks');
    let emoji, rName;
    if (wins < 20) { emoji = "‚õìÔ∏è"; rName = "Demir"; }
    else if (wins < 40) { emoji = "ü•à"; rName = "G√ºm√º≈ü"; }
    else if (wins < 60) { emoji = "ü•á"; rName = "Altƒ±n"; }
    else { emoji = "üíé"; rName = "Elmas"; }
    document.getElementById('rank-emoji').innerText = emoji;
    document.getElementById('rank-name').innerText = rName;
    ticksContainer.innerHTML = '';
    for(let i=0; i<20; i++) {
        let t = document.createElement('div');
        t.className = 'tick' + (i < (wins % 20) ? ' active' : '');
        ticksContainer.appendChild(t);
    }
}

function saveProfile() { localStorage.setItem('weekWorldProfile', JSON.stringify(profileData)); }
function openMarket() { document.getElementById('market-menu').style.display = 'flex'; initMarket(); updateUI(); }
function closeMarket() { document.getElementById('market-menu').style.display = 'none'; }
function openChallenges() { document.getElementById('challenge-menu').style.display = 'flex'; updateUI(); }
function closeChallenges() { document.getElementById('challenge-menu').style.display = 'none'; }
function openProfileEdit() { document.getElementById('profile-edit-menu').style.display = 'flex'; renderInventory(); }
function closeProfileEdit() { profileData.name = document.getElementById('name-input').value || profileData.name; saveProfile(); updateUI(); document.getElementById('profile-edit-menu').style.display = 'none'; }

/* --- OYUN MANTIƒûI VE ≈ûEHƒ∞R VERƒ∞LERƒ∞ --- */
function startCountdown(mode) {
    const overlay = document.getElementById('start-countdown-overlay');
    const num = document.getElementById('countdown-num');
    document.getElementById('main-menu').style.visibility = 'hidden';
    document.getElementById('challenge-menu').style.display = 'none';
    overlay.style.display = 'flex';
    overlay.classList.remove('slide-up-out'); overlay.classList.add('fade-zoom-in');
    let c = 5; num.innerText = c;
    let int = setInterval(() => {
        c--;
        if(c > 0) num.innerText = c;
        else if(c === 0) num.innerText = "BA≈ûLA!";
        else { clearInterval(int); overlay.classList.replace('fade-zoom-in', 'slide-up-out'); setTimeout(() => { overlay.style.display = 'none'; startGame(mode); }, 600); }
    }, 1000);
}

// 30 KOLAY ≈ûEHƒ∞R
var citiesEasy = [
    ["ƒ∞stanbul", 41.00, 28.97], ["Ankara", 39.93, 32.85], ["ƒ∞zmir", 38.41, 27.12], ["Antalya", 36.89, 30.71],
    ["Londra", 51.50, -0.12], ["Paris", 48.85, 2.35], ["Berlin", 52.52, 13.40], ["Roma", 41.90, 12.49],
    ["Madrid", 40.41, -3.70], ["Tokyo", 35.67, 139.65], ["New York", 40.71, -74.00], ["Sidney", -33.86, 151.20],
    ["Moskova", 55.75, 37.61], ["Dubai", 25.20, 55.27], ["Amsterdam", 52.36, 4.89], ["Br√ºksel", 50.85, 4.35],
    ["Viyana", 48.20, 16.37], ["Atina", 37.98, 23.72], ["Kahire", 30.04, 31.23], ["Pekin", 39.90, 116.40],
    ["Seul", 37.56, 126.97], ["Rio de Janeiro", -22.90, -43.17], ["Buenos Aires", -34.60, -58.38], ["Toronto", 43.65, -79.38],
    ["Los Angeles", 34.05, -118.24], ["Meksika City", 19.43, -99.13], ["Bangkok", 13.75, 100.50], ["Singapur", 1.35, 103.81],
    ["Lizbon", 38.72, -9.13], ["Stokholm", 59.32, 18.06]
];

// 34 ORTA ≈ûEHƒ∞R (Geoguessr a≈üinalƒ±ƒüƒ± gerektirir ama imkansƒ±z deƒüil)
var citiesHard = [
    ["Var≈üova", 52.22, 21.01], ["Prag", 50.07, 14.43], ["Budape≈üte", 47.49, 19.04], ["Cape Town", -33.92, 18.42],
    ["Helsinki", 60.16, 24.93], ["Oslo", 59.91, 10.75], ["Kopenhag", 55.67, 12.56], ["Z√ºrih", 47.37, 8.54],
    ["Dublin", 53.34, -6.26], ["Reykjavik", 64.12, -21.82], ["Yeni Delhi", 28.61, 77.20], ["Kuala Lumpur", 3.13, 101.68],
    ["Manila", 14.59, 120.98], ["Cakarta", -6.20, 106.84], ["Santiago", -33.44, -70.66], ["Lima", -12.04, -77.04],
    ["Bogota", 4.71, -74.07], ["Hanoi", 21.02, 105.83], ["Taipei", 25.03, 121.56], ["B√ºkre≈ü", 44.42, 26.10],
    ["Belgrad", 44.78, 20.44], ["Sofya", 42.69, 23.32], ["Lagos", 6.52, 3.37], ["Nairobi", -1.29, 36.82],
    ["Kazablanka", 33.57, -7.58], ["Bak√º", 40.40, 49.86], ["Tiflis", 41.71, 44.78], ["Astana", 51.16, 71.47],
    ["Amman", 31.94, 35.92], ["Beyrut", 33.89, 35.50], ["Riyad", 24.71, 46.67], ["Tel Aviv", 32.08, 34.78],
    ["Kiev", 50.45, 30.52], ["Perth", -31.95, 115.86]
];

var map = L.map('map', {zoomControl: false, attributionControl: false, worldCopyJump: true}).setView([20,0], 3);
var baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
var blindLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png');

var selectedCity, guessMarker=null, realMarker=null, line=null, score=0, timeLeft=120, roundActive=false, currentMode='normal', timerInterval, nextRoundInterval;

function startGame(mode) {
    currentMode = mode; score = 0; document.getElementById("score").innerText = "0";
    document.getElementById('game-top-bar').style.visibility = 'visible';
    document.getElementById('game-bottom-bar').style.visibility = 'visible';
    document.getElementById('timer').style.visibility = (mode === 'hardcore' ? 'hidden' : 'visible');
    if(mode === 'blind_shot') { map.removeLayer(baseLayer); blindLayer.addTo(map); timeLeft = 180; }
    else { map.removeLayer(blindLayer); baseLayer.addTo(map); }
    if(mode === 'total_time') timeLeft = 120; // 5 dakikadan 2 dakikaya (120 saniye) d√º≈ü√ºr√ºld√º.
    map.invalidateSize(); startRound(true);
}

function startRound(first = false) {
    if(score >= 25000) { showFinalScreen(); return; }
    if(guessMarker) map.removeLayer(guessMarker); if(realMarker) map.removeLayer(realMarker); if(line) map.removeLayer(line);
    guessMarker = null; document.getElementById("guessBtn").classList.remove("active");
    document.getElementById("distanceBox").style.display="none"; document.getElementById("guessBtn").style.display="block";
    
    if(currentMode === 'speedrun' && first) timeLeft = 60;
    else if(currentMode === 'normal') timeLeft = 120;
    
    // %50 KOLAY, %50 ORTA-ZOR SE√áƒ∞Mƒ∞
    let pool = Math.random() < 0.5 ? citiesEasy : citiesHard;
    
    selectedCity = pool[Math.floor(Math.random()*pool.length)];
    
    document.getElementById("cityName").innerText = selectedCity[0];
    roundActive = true; updateTimerUI(); clearInterval(timerInterval);
    if(currentMode !== 'hardcore') { 
        timerInterval = setInterval(() => { 
            timeLeft--; 
            updateTimerUI(); 
            if(timeLeft<=0) gameOver("S√ºre Doldu!"); 
        }, 1000); 
    }
}

function updateTimerUI() {
    let m = Math.floor(timeLeft/60), s = timeLeft%60;
    document.getElementById("timer").innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

map.on('click', (e) => {
    if(!roundActive) return;
    if(guessMarker) map.removeLayer(guessMarker);
    guessMarker = L.marker(e.latlng).addTo(map);
    document.getElementById("guessBtn").classList.add("active");
});

function makeGuess() {
    if(!roundActive || !guessMarker) return;
    roundActive = false; clearInterval(timerInterval);
    document.getElementById("guessBtn").style.display = "none";
    let realPos = L.latLng(selectedCity[1], selectedCity[2]);
    let guessPos = guessMarker.getLatLng();
    realMarker = L.marker(realPos).addTo(map);
    line = L.polyline([guessPos, realPos], {color: 'red', weight: 3}).addTo(map);
    let dist = Math.round(map.distance(guessPos, realPos) / 1000);
    if((currentMode === 'hardcore' || currentMode === 'blind_shot') && dist > 500) { gameOver("500km sƒ±nƒ±rƒ± a≈üƒ±ldƒ±!"); return; }
    if(currentMode === 'speedrun' && dist <= 500) timeLeft = 60;
    let roundScore = Math.max(0, 5000 - (dist * 5));
    score += roundScore;
    document.getElementById("score").innerText = score;
    document.getElementById("distanceBox").innerText = `${dist} km | +${roundScore} Puan`;
    document.getElementById("distanceBox").style.display = "block";
    if(score >= 25000) setTimeout(showFinalScreen, 1500); else startMola();
}

function startMola() {
    let molaTime = 5; let originalTime = timeLeft;
    document.getElementById("timer").innerText = "Mola: " + molaTime;
    clearInterval(nextRoundInterval);
    nextRoundInterval = setInterval(() => {
        molaTime--;
        document.getElementById("timer").innerText = "Mola: " + molaTime;
        if(molaTime <= 0) {
            clearInterval(nextRoundInterval);
            if(currentMode === 'total_time' || currentMode === 'speedrun' || currentMode === 'blind_shot') timeLeft = originalTime;
            startRound();
        }
    }, 1000);
}

function gameOver(msg) {
    clearInterval(timerInterval); clearInterval(nextRoundInterval);
    document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = `<h2>OYUN Bƒ∞TTƒ∞</h2><p>${msg}</p><button onclick="location.reload()" style="padding:15px 30px; background:#ffcc00; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">LOBƒ∞YE D√ñN</button>`;
}

function showFinalScreen() {
    const challengeModes = ['blind_shot', 'total_time'];
    const isChallenge = challengeModes.includes(currentMode);
    if(!isChallenge) { wins++; localStorage.setItem('weekWorldWins', wins); }
    if(isChallenge) { medals++; localStorage.setItem('weekWorldMedals', medals); }
    document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = `<h2 style="color:green">TEBRƒ∞KLER!</h2><p>25.000 Puan Barajƒ±nƒ± Ge√ßtin!${isChallenge ? '<br>+1 Madalya Kazandƒ±n!' : ''}</p><button onclick="location.reload()" style="padding:15px 30px; background:#2962ff; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">LOBƒ∞YE D√ñN</button>`;
}

/* --- 3D D√úNYA --- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(40, 1, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(380, 380); document.getElementById('world-3d-container').appendChild(renderer.domElement);
const globe = new THREE.Mesh(new THREE.SphereGeometry(2, 64, 64), new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg') }));
scene.add(globe);
const light = new THREE.DirectionalLight(0xffffff, 1.3); light.position.set(5,3,5); scene.add(light);
scene.add(new THREE.AmbientLight(0x666666)); camera.position.z = 5.5;
let isDragging = false; let prevMouse = {x:0, y:0};
document.getElementById('world-3d-container').onmousedown = () => isDragging = true;
window.onmouseup = () => isDragging = false;
window.onmousemove = (e) => { if(isDragging) { globe.rotation.y += (e.clientX - prevMouse.x)*0.01; globe.rotation.x += (e.clientY - prevMouse.y)*0.01; } prevMouse = {x:e.clientX, y:e.clientY}; };
function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
animate(); updateUI();
</script>
</body>
</html>
