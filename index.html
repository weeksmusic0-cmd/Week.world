<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Week.world vers. 1.9</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<style>
    /* SCROLLBAR Gƒ∞ZLEME */
    ::-webkit-scrollbar { display: none !important; }
    * { -ms-overflow-style: none !important; scrollbar-width: none !important; }

    body{margin:0;font-family:'Segoe UI',Arial;overflow:hidden; background: #000; color: white;}
    #map{height:100vh; width:100%; cursor:crosshair; background: #222; position: absolute; top:0; left:0; z-index: 1;}

    /* AYARLAR BUTONU */
    #settings-toggle {
        position: fixed; top: 20px; left: 20px; z-index: 30005;
        background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.2); color: white;
        padding: 10px; border-radius: 50%; width: 50px; height: 50px;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; cursor: pointer; backdrop-filter: blur(5px);
        transition: 0.3s; user-select: none;
    }
    #settings-toggle:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.1); }

    /* GE√áƒ∞≈û PERDESƒ∞ */
    #transition-curtain {
        position: fixed; bottom: -100%; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 30000; transition: bottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
    }
    #transition-curtain.active { bottom: 0; }

    /* MEN√ú VE EKRANLAR */
    #main-menu, #challenge-menu, #profile-edit-menu, #market-menu, #achievement-menu, #quest-menu, #settings-menu, #season-pass-menu {
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #050505; z-index: 9999;
        display: flex; justify-content: space-between; align-items: center;
        transition: opacity 0.5s ease;
    }
    #challenge-menu, #profile-edit-menu, #market-menu, #achievement-menu, #quest-menu, #settings-menu, #season-pass-menu { 
        display: none; flex-direction: column; justify-content: center; z-index: 10001; 
    }

    /* Kƒ∞TAP TEMALI AYARLAR EKRANI */
    .book-container {
        background: #fdf6e3; border-radius: 10px; padding: 40px; color: #333; max-width: 600px; width: 90%; 
        position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.05);
        display: flex; flex-direction: column; gap: 20px;
    }

    /* GE√áƒ∞≈û EKRANI */
    #start-countdown-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, #1a1a1a 0%, #000 100%); z-index: 20000;
        display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
    }
    .slide-up-out { animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    @keyframes slideUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
    .countdown-number { font-size: 12rem; font-weight: 900; color: white; animation: pulseNumber 1s infinite; }
    @keyframes pulseNumber { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 1; } }

    /* PUAN ANƒ∞MASYON KATMANI */
    #score-animation-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 50000; display: none; align-items: center; justify-content: center; pointer-events: none;
    }
    .score-anim-container { position: relative; display: flex; align-items: center; justify-content: center; }
    .big-score-text { font-size: 10rem; font-weight: 900; color: #ffcc00; transform: scale(0);
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .added-score-text {
        position: absolute; top: -60px; left: -40px; font-size: 4rem; font-weight: 900; color: #ffcc00;
        opacity: 0; transform: translateY(20px); transition: 0.5s ease-out;
    }
    .big-score-text.active { transform: scale(1); }
    .added-score-text.active { opacity: 1; transform: translateY(0); }

    /* MARKET VE Dƒ∞ƒûER MEN√úLER */
    .market-header { position: absolute; top: 30px; right: 50px; display: flex; align-items: center; gap: 15px; font-size: 24px; font-weight: bold; color: #ffcc00; }
    .market-container { width: 90%; max-height: 85vh; overflow-y: auto; padding: 20px; text-align: center; }
    .market-section-title { font-size: 1.8rem; color: #ffcc00; margin: 40px 0 20px 0; border-bottom: 2px solid #333; padding-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
    .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; margin-bottom: 50px; }
    .market-item { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 20px; padding: 20px; transition: 0.3s; }
    .item-img-preview { width: 80px; height: 80px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #444; object-fit: cover; pointer-events: none; }
    .frame-preview { border-radius: 50%; border: 4px solid; position: relative; overflow: hidden; }
    .item-name { font-weight: bold; margin-bottom: 5px; font-size: 14px; height: 40px; display: flex; align-items: center; justify-content: center; text-align: center; }
    .item-price { color: #ffcc00; font-size: 18px; font-weight: bold; margin-bottom: 15px; }
    .buy-btn { background: #2962ff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
    .buy-btn:hover { background: #0039cb; }
    .buy-btn.owned { background: #444; cursor: default; }
    .buy-btn:disabled { background: #333; color: #777; cursor: not-allowed; }

    /* SEZON Bƒ∞LETƒ∞ EKRANI */
    .pass-container { display: flex; overflow-x: auto; gap: 25px; padding: 20px; height: 50vh; align-items: center; width: 90%; max-width: 1400px; margin-top: 50px; }
    .pass-tier { width: 220px; min-width: 220px; background: rgba(20, 25, 35, 0.9); border: 2px solid #333; border-radius: 20px; padding: 20px; text-align: center; position: relative; transition: 0.3s; }
    .pass-tier.unlocked { border-color: #ffcc00; box-shadow: 0 0 15px rgba(255,204,0,0.3); background: rgba(255,204,0,0.1); }
    .pass-tier.claimed { border-color: #00c853; opacity: 0.7; }
    .tier-level { font-size: 1.2rem; font-weight: bold; color: #888; margin-bottom: 5px; text-transform: uppercase; }
    .tier-xp { font-size: 0.8rem; color: #ffcc00; margin-bottom: 15px; font-weight: bold; }
    .tier-level.unlocked { color: white; }
    #pass-timer { position: absolute; bottom: 30px; right: 40px; font-size: 1.2rem; font-weight: bold; color: #ffcc00; font-family: monospace; }

    /* XP ANƒ∞MASYONU EKRANI (LOBƒ∞ ƒ∞√áƒ∞N) */
    #xp-anim-container {
        position: fixed; bottom: -150px; left: 50%; transform: translateX(-50%); z-index: 99999;
        width: 400px; display: flex; flex-direction: column; gap: 10px; align-items: center;
        transition: bottom 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none;
    }
    #xp-anim-container.show { bottom: 50px; }
    #xp-anim-text {
        font-size: 3.5rem; font-weight: 900; color: #ffcc00;
        text-shadow: 3px 3px 0 #d84315, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        text-align: center; transform: translateY(-50px) scale(0); opacity: 0; transition: 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex; justify-content: center; align-items: center; font-family: 'Arial Black', sans-serif; height: 60px;
    }
    #xp-anim-text.pop { transform: translateY(0) scale(1); opacity: 1; }
    .shatter-span { display: inline-block; transition: 1.2s cubic-bezier(0.25, 1, 0.5, 1); }
    .shatter-active { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(1.5); filter: blur(2px); }
    #xp-anim-bar-bg { width: 100%; height: 30px; background: rgba(0,0,0,0.8); border: 3px solid #ffcc00; border-radius: 15px; overflow: hidden; box-shadow: 0 0 15px rgba(255, 204, 0, 0.6); position: relative; }
    #xp-anim-bar-fill { height: 100%; background: linear-gradient(90deg, #ff9800, #ffeb3b); width: 0%; transition: width 1.5s ease-in-out; }
    #xp-anim-bar-text { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:16px; color:white; text-shadow:1px 1px 3px black; z-index:2; }

    /* LOBƒ∞ */
    .center-stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; z-index: 10000; }
    .game-title { color: white; font-size: 4.5rem; margin: 0 0 10px 0; letter-spacing: -2px; pointer-events: none; }
    #world-3d-container { width: 380px; height: 380px; cursor: grab; }
    .disclaimer-text { font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); margin-top: 20px; max-width: 300px; text-align: center; line-height: 1.4; font-style: italic; pointer-events: none; user-select: none; }

    .side-menu-left { display: flex; flex-direction: column; gap: 20px; margin-left: 50px; z-index: 10000; }
    .mode-card { width: 260px; height: 110px; background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 15px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.4s; position: relative; overflow: hidden; }
    .mode-card:hover { border-color: #ffcc00; transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); }
    .mode-title { font-size: 1.1rem; font-weight: bold; text-align: center; transition: 0.3s; }
    .mode-desc { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 85%; font-size: 0.85rem; color: #ffcc00; opacity: 0; transition: 0.3s; pointer-events: none; }
    .mode-card:hover .mode-title { opacity: 0; }
    .mode-card:hover .mode-desc { opacity: 1; }
    
    .achv-card { cursor: default; transition: 0.4s; }
    .achv-card:hover { border-color: #9c27b0; transform: translateY(-5px); background: rgba(156, 39, 176, 0.1); }
    .achv-title { font-size: 1.4rem; font-weight: 900; color: white; transition: 0.3s; }
    .achv-card:hover .achv-title { opacity: 0; }
    .achv-card:hover .mode-desc { opacity: 1; }

    .side-menu-right { position: absolute; top: 25px; right: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 10000; }
    .panel-box { background: rgba(20, 25, 35, 0.9); padding: 15px 20px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); width: 260px; }
    
    .mini-profile { cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
    .avatar-wrapper { width: 64px; height: 64px; position: relative; display: flex; align-items: center; justify-content: center; }
    .avatar-img { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; background: #333; z-index: 1; pointer-events: none; }
    .avatar-frame { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; pointer-events: none; z-index: 2; box-sizing: border-box; }

    .inventory-section { background: rgba(0,0,0,0.5); border-radius: 15px; padding: 15px; margin-bottom: 20px; text-align: left; border: 1px solid #333; }
    .inventory-title { color: #888; font-size: 12px; margin-bottom: 10px; font-weight: bold; text-transform: uppercase;}
    .inventory-grid { display: flex; gap: 15px; flex-wrap: wrap; }
    .title-tag { background: #222; border: 1px solid #444; color: #eee; padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: 0.2s; }
    .title-tag.active { background: #ffcc00; color: #000 !important; font-weight: bold; border-color: #ffcc00; }
    .title-tag.active span { -webkit-text-fill-color: #000 !important; }

    /* OYUN TASARIMI */
    .top-bar{ position:absolute;top:20px;left:0;width:100%; display:flex;justify-content:space-between;padding:0 30px;box-sizing:border-box;z-index:1000; visibility: hidden; pointer-events: none;}
    .city-box{ background: #6a1b9a; padding:12px 25px; border-radius:12px; color:#ffcc00; font-size: 20px; pointer-events: auto; font-family: 'Arial Black', 'Gadget', sans-serif; text-transform: capitalize; }
    .score-box{ background: #6a1b9a; color:#ffcc00; padding:12px 25px; border-radius:12px; min-width:140px; text-align:center; pointer-events: auto; font-family: 'Arial Black', 'Gadget', sans-serif; text-transform: capitalize; }
    .timer-box{ position:absolute; top:20px; left:50%; transform:translateX(-50%); background: #6a1b9a; color:#ffcc00; padding:12px 30px; border-radius:20px; font-size: 22px; z-index:1000; visibility: hidden; font-family: 'Arial Black', 'Gadget', sans-serif; text-transform: capitalize; }
    .distance-box{ position:absolute;top:85px;left:50%;transform:translateX(-50%); background:#2962ff;color:white;padding:10px 25px;border-radius:20px; font-weight:bold;z-index:1000;display:none; text-transform: capitalize; }
    .bottom-bar{ position:absolute;bottom:40px;left:50%;transform:translateX(-50%); z-index:1000; visibility: hidden;}
    .guess-btn { padding:16px 60px; font-size:20px; border-radius:40px; background: #6a1b9a; color:#ffcc00; cursor:pointer; border:none; opacity: 0.4; pointer-events: none; transition: 0.3s; font-family: 'Arial Black', 'Gadget', sans-serif; text-transform: capitalize; }
    .guess-btn.active { opacity: 1; pointer-events: auto; }

    .result-box{ position:fixed;top:50%;left:50%;transform:translate(-50%,-50%); background:white;padding:40px;border-radius:24px; z-index:10001; display:none; text-align:center; color: black; }
    .back-btn { padding: 12px 30px; background: rgba(255,255,255,0.1); color: white; border-radius: 10px; cursor: pointer; border: 1px solid #444; font-weight: bold;}
    .win-bar { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; display: flex; gap: 2px; padding: 2px; }
    .tick { flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px; }
    .tick.active { background: #ffcc00; }

    /* BA≈ûARIM VE G√ñREV Bƒ∞LDƒ∞Rƒ∞M EKRANI */
    #achv-notification {
        position: fixed; bottom: 40px; right: -400px;
        background: #6a1b9a; color: white; padding: 20px 30px; border-radius: 15px; display: flex; align-items: center; gap: 15px;
        box-shadow: 0 0 20px rgba(106, 27, 154, 0.8); z-index: 99999; transition: right 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .achv-notif-text-container { display: flex; flex-direction: column; position: relative; }
    #achv-medal-badge {
        position: absolute; top: -10px; right: -20px; background: #ffcc00; color: black;
        font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 10px; display: none;
    }

    /* √ñZEL √áER√áEVELER */
    .fire-frame { border: 4px solid transparent !important; background-image: linear-gradient(#000, #000), linear-gradient(to right, orange, red, yellow); background-origin: border-box; background-clip: content-box, border-box; animation: rotateGradient 2s linear infinite; }
    @keyframes rotateGradient { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

    /* G√ñREVLER MEN√úS√ú CSS */
    .quest-container { display: flex; width: 90%; max-width: 1200px; height: 75vh; gap: 30px; }
    .quest-column { flex: 1; background: rgba(20, 25, 35, 0.9); border: 1px solid #333; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; }
    .quest-column-header { text-align: center; font-size: 2rem; font-weight: bold; color: #ffcc00; margin-bottom: 5px; }
    .quest-timer { text-align: center; color: #aaa; font-size: 0.9rem; margin-bottom: 20px; }
    .quest-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-right: 10px; }
    .quest-item { background: rgba(0, 0, 0, 0.5); border: 1px solid #444; border-radius: 15px; padding: 15px; display: flex; align-items: center; gap: 15px; position: relative; transition: 0.3s; }
    .quest-item:hover { border-color: #6a1b9a; background: rgba(106, 27, 154, 0.1); }
    .quest-emoji { font-size: 2.5rem; }
    .quest-details { flex: 1; }
    .quest-title { font-size: 1.2rem; font-weight: bold; color: white; margin-bottom: 5px; }
    .quest-desc { font-size: 0.85rem; color: #ccc; margin-bottom: 10px; }
    .quest-progress-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
    .quest-progress-bar-fill { height: 100%; background: #2962ff; transition: width 0.3s ease; }
    .quest-reward { position: absolute; top: 15px; right: 15px; font-weight: bold; color: #ffcc00; font-size: 0.9rem; }
    .quest-claim-btn { position: absolute; bottom: 15px; right: 15px; background: #00c853; color: white; border: none; padding: 6px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: none; transition: 0.2s; }
    .quest-claim-btn:hover { background: #00e676; transform: scale(1.05); }
    .quest-item.completed .quest-progress-bar-fill { background: #00c853; }
    .quest-item.claimed { opacity: 0.5; pointer-events: none; border-color: #222; }
    .quest-item.claimed .quest-claim-btn { display: block; background: #444; color: #888; text-transform: uppercase; cursor: default; }

    .bottom-buttons-container { position: absolute; bottom: 30px; right: 30px; z-index: 10000; display: flex; gap: 20px; }
</style>
</head>
<body onclick="initFirstAudio()">

<div id="transition-curtain"></div>
<div id="settings-toggle" onclick="openSettings(event)" title="Ayarlarƒ± a√ßmak i√ßin tƒ±klayƒ±n">üìñ</div>

<div id="score-animation-overlay">
    <div class="score-anim-container">
        <div id="anim-added-score" class="added-score-text">+0</div>
        <div id="anim-main-score" class="big-score-text">0</div>
    </div>
</div>

<div id="start-countdown-overlay">
    <div style="font-size: 2.5rem; font-weight: 800; color: #ffcc00; margin-bottom: 20px;">OYUNUN BA≈ûLAMASINA</div>
    <div id="countdown-num" class="countdown-number">5</div>
</div>

<div id="achv-notification">
    <span id="achv-notif-emoji" style="font-size: 35px;">üèÖ</span>
    <div class="achv-notif-text-container">
        <div id="achv-medal-badge">+1 üèÜ</div>
        <span id="achv-notif-type" style="font-size: 13px; font-weight: bold; color: #e1bee7; margin-bottom: 3px;">BA≈ûARIM KAZANILDI</span>
        <span id="achv-notif-title" style="font-size: 18px; font-weight: 900; opacity: 0; transition: opacity 1s ease-in;">≈ûampiyon</span>
    </div>
</div>

<div id="settings-menu">
    <div class="book-container">
        <h2 style="color: #6a1b9a; text-align: center; margin-top: 0; font-family: 'Georgia', serif; font-size: 2rem;">Ayarlar & ƒ∞statistikler</h2>
        <div style="text-align: center; margin: 10px 0;">
            <button id="in-menu-music-toggle" onclick="toggleGlobalMusic(event)" style="padding: 12px 25px; font-size: 16px; border-radius: 8px; cursor:pointer; background: #6a1b9a; color: #ffcc00; border: none; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">üîä Sesi Kapat</button>
        </div>
        <div style="font-size: 18px; line-height: 2; font-weight: bold; font-family: 'Courier New', monospace; padding: 20px; background: rgba(0,0,0,0.05); border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding-bottom: 5px;"><span>Oynanan oyunlar:</span> <span id="stat-played">0</span></div>
            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 10px;"><span>Kazanƒ±lan oyunlar:</span> <span id="stat-won">0</span></div>
            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 10px;"><span>Kaybedilen oyunlar:</span> <span id="stat-lost">0</span></div>
            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 10px;"><span>Tamamlanan meydan okumalar:</span> <span id="stat-challenges">0</span></div>
            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-top: 10px;"><span>Kazanƒ±lan madalya:</span> <span id="stat-earned-medals">0</span></div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px;"><span>Harcanan madalya:</span> <span id="stat-spent-medals">0</span></div>
        </div>
        <button onclick="closeSettings()" style="margin-top: 20px; width: 100%; padding: 15px; background: #222; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">Kapat</button>
    </div>
</div>

<div id="main-menu">
    <div class="side-menu-left">
        <div class="mode-card" onclick="startCountdown('normal')"><span class="mode-title">üåç D√úNYA MODU</span><span class="mode-desc">Klasik deneyim. Hedef 25.000 puan.</span></div>
        <div class="mode-card" onclick="startCountdown('speedrun')"><span class="mode-title">‚è±Ô∏è S√úRELƒ∞ MOD</span><span class="mode-desc">500km altƒ±na inersen s√ºre 1 dakikaya sƒ±fƒ±rlanƒ±r!</span></div>
        <div class="mode-card" onclick="startCountdown('hardcore')"><span class="mode-title">üß≠ ZOR MOD</span><span class="mode-desc">Hata payƒ± yok (500km sƒ±nƒ±r).</span></div>
        <div class="mode-card" onclick="openChallenges()"><span class="mode-title">üìö MEYDAN OKUMALAR</span><span class="mode-desc">√ñzel √∂d√ºller ve madalyalar kazan.</span></div>
    </div>
    
    <div class="center-stage">
        <h1 class="game-title">Week.world</h1>
        <div id="world-3d-container"></div>
        <div class="disclaimer-text">Oyunumuz tamamƒ±yla eƒülence ama√ßlƒ±dƒ±r herhangi bir para kazanma gibi bir amacƒ±mƒ±z yoktur!</div>
    </div>
    
    <div class="side-menu-right">
        <div class="panel-box mini-profile" onclick="openProfileEdit()">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="avatar-wrapper"><img src="" id="display-avatar" class="avatar-img"><div id="display-frame" class="avatar-frame"></div></div>
                <div><div id="display-name" style="font-weight:bold;">Oyuncu</div><div id="display-title" style="font-size:10px; color:#ffcc00; font-weight:bold;">YENƒ∞ OYUNCU</div></div>
            </div>
        </div>
        <div class="panel-box"><div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;"><span id="rank-emoji" style="font-size:36px;">‚õìÔ∏è</span><div><div style="font-size: 10px; color: #888;">RANK</div><div id="rank-name" style="font-weight:bold;">Demir</div></div></div><div class="win-bar" id="win-ticks"></div></div>
        <div class="panel-box"><div style="font-size: 10px; color: #888;">TOPLAM OYNAMA S√úRESƒ∞</div><div id="playtime-display" style="font-size: 14px; font-weight: bold; color: #ffcc00; margin-top: 5px;">0 G√ºn 0 Saat 0 Dakika</div></div>
        <button class="buy-btn" style="height:50px; font-size:16px; background: linear-gradient(45deg, #6200ea, #2962ff);" onclick="openMarket()">üõí MARKET</button>
    </div>

    <div class="bottom-buttons-container">
        <div class="mode-card" style="width: 260px;" onclick="openAchievements()">
            <span class="mode-title">üèÖ BA≈ûARIMLAR</span>
            <span class="mode-desc">Ba≈üarƒ±mlarƒ± G√∂r√ºnt√ºle</span>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; width: 260px;">
            <button class="buy-btn" style="background: #ffb300; color: black; height: 50px; font-size: 16px; padding:0;" onclick="openSeasonPass()">üé´ SEZON Bƒ∞LETƒ∞</button>
            <div class="mode-card" style="width: 100%; height: 50px; margin:0;" onclick="openQuests()">
                <span class="mode-title">üìú G√ñREVLER</span>
                <span class="mode-desc">G√∂revlerini g√∂rmek i√ßin tƒ±kla.</span>
            </div>
        </div>
    </div>
</div>

<div id="achievement-menu">
    <h2 id="achv-header" style="font-size: 3rem; font-weight: 900; color: #ffcc00; margin-bottom: 40px; margin-top: 50px;">Sahip olunan ba≈üarƒ±mlar: 0</h2>
    <div id="achv-grid" class="drag-area" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 900px; padding: 20px; overflow-y: auto; height: 60vh;"></div>
    <button class="back-btn" style="position: absolute; bottom: 40px; left: 40px;" onclick="closeAchievements()">‚Üê GERƒ∞ D√ñN</button>
</div>

<div id="season-pass-menu">
    <h2 style="font-size: 3rem; font-weight: 900; color: #ffcc00; margin-top: 50px; margin-bottom: 0;">üé´ Sezon Bileti</h2>
    <div style="color:#aaa; font-size:1.2rem; margin-bottom: 20px;">√ñd√ºlleri kazanmak i√ßin oyun oynayarak XP topla! Toplam XP: <span id="pass-total-xp" style="color:white; font-weight:bold;">0</span></div>
    
    <div class="pass-container drag-area" id="pass-grid"></div>
    
    <div id="pass-timer">Sezonun bitmesine kalan zaman: -- g√ºn -- saat</div>
    <button class="back-btn" style="position: absolute; bottom: 40px; left: 40px;" onclick="closeSeasonPass()">‚Üê GERƒ∞ D√ñN</button>
</div>

<div id="quest-menu">
    <div class="quest-container">
        <div class="quest-column">
            <div class="quest-column-header">G√ºnl√ºk G√∂revler</div>
            <div class="quest-timer" id="daily-timer">Yenilenmeye Kalan S√ºre: --:--:--</div>
            <div class="quest-list drag-area" id="daily-quest-list"></div>
        </div>
        <div class="quest-column">
            <div class="quest-column-header">Haftalƒ±k G√∂revler</div>
            <div class="quest-timer" id="weekly-timer">Yenilenmeye Kalan S√ºre: -- G√ºn --:--:--</div>
            <div class="quest-list drag-area" id="weekly-quest-list"></div>
        </div>
    </div>
    <button class="back-btn" style="position: absolute; bottom: 40px; left: 40px;" onclick="closeQuests()">‚Üê GERƒ∞ D√ñN</button>
</div>

<div id="market-menu">
    <div class="market-header">üèÜ <span id="market-medal-count">0</span></div>
    <div class="market-container drag-area">
        <h2 class="market-section-title">üñºÔ∏è Profil Fotoƒüraflarƒ±</h2>
        <div class="market-grid" id="market-grid-photos"></div>
        <h2 class="market-section-title">‚ú® Avatar √áer√ßeveleri</h2>
        <div class="market-grid" id="market-grid-frames"></div>
        <h2 class="market-section-title">üéñÔ∏è √únvanlar</h2>
        <div class="market-grid" id="market-grid-titles"></div>
        <h2 class="market-section-title">üó∫Ô∏è Harita Stilleri</h2>
        <div class="market-grid" id="market-grid-maps"></div>
    </div>
    <button class="back-btn" style="position: absolute; bottom: 40px; left: 40px;" onclick="closeMarket()">‚Üê GERƒ∞ D√ñN</button>
</div>

<div id="challenge-menu">
    <h2 style="font-size: 3rem;">Meydan Okumalar</h2>
    <div style="display:flex; gap:20px; margin-top: 20px;">
        <div class="mode-card" onclick="startCountdown('total_time')"><span class="mode-title">‚è≥ TOPLAM S√úRE</span><span class="mode-desc">25.000 puan i√ßin toplam 2 dakikan var!</span></div>
        <div class="mode-card" onclick="startCountdown('blind_shot')"><span class="mode-title">üåë K√ñR ATI≈û</span><span class="mode-desc">Sƒ±nƒ±rsƒ±z harita, 500km sƒ±nƒ±r ve 3 dk!</span></div>
    </div>
    <div class="panel-box" style="margin-top:40px; width: auto; padding: 15px 40px; text-align: center;">üèÜ MADALYALAR: <span id="challenge-medal-count" style="font-weight:bold; color:#ffcc00; font-size: 24px;">0</span></div>
    <button class="back-btn" style="position: absolute; bottom: 40px; left: 40px;" onclick="closeChallenges()">‚Üê GERƒ∞</button>
</div>

<div id="profile-edit-menu" class="drag-area" style="background: rgba(15, 15, 20, 0.95); border: 1px solid #333; width: 700px; padding: 40px; border-radius: 20px; text-align: center; margin: auto; max-height: 80vh; overflow-y: auto;">
    <h2 style="margin-top: 0; color: #ffcc00;">Profil ve Envanter</h2>
    <div style="margin-bottom: 30px;"><div class="inventory-title">KULLANICI ADI</div><input type="text" id="name-input" placeholder="ƒ∞sim Deƒüi≈ütir" style="padding:15px; border-radius:10px; border: 1px solid #444; background: rgba(0,0,0,0.5); color: white; width:80%; font-size: 16px; text-align: center;"></div>
    <div class="inventory-section"><div class="inventory-title">SAHƒ∞P OLUNAN √úNVANLAR</div><div class="inventory-grid drag-area" id="inv-titles" style="justify-content: center; overflow-x: auto;"></div></div>
    <div class="inventory-section"><div class="inventory-title">MEVCUT HARƒ∞TA STƒ∞LLERƒ∞</div><div class="inventory-grid drag-area" id="inv-maps" style="justify-content: center; overflow-x: auto;"></div></div>
    <div class="inventory-section"><div class="inventory-title">SAHƒ∞P OLUNAN AVATARLAR</div><div class="inventory-grid drag-area" id="inv-avatars" style="overflow-x: auto;"></div></div>
    <div class="inventory-section"><div class="inventory-title">SAHƒ∞P OLUNAN √áER√áEVELER</div><div class="inventory-grid drag-area" id="inv-frames" style="overflow-x: auto;"></div></div>
    <button class="back-btn" style="margin-top: 20px; width: 200px; background: #2962ff; border: none;" onclick="closeProfileEdit()">KAYDET VE √áIK</button>
</div>

<div class="top-bar" id="game-top-bar">
    <div class="city-box">Hedef: <span id="cityName">≈üehir</span></div>
    <div class="score-box">Puan: <span id="score">0</span></div>
</div>
<div class="timer-box" id="timer">02:00</div>
<div class="distance-box" id="distanceBox"></div>
<div class="bottom-bar" id="game-bottom-bar">
    <button class="guess-btn" id="guessBtn" onclick="makeGuess()">Tahmin Et</button>
</div>
<div class="result-box" id="result"></div>
<div id="map"></div>

<div id="xp-anim-container">
    <div id="xp-anim-text"></div>
    <div id="xp-anim-bar-bg">
        <div id="xp-anim-bar-fill"></div>
        <div id="xp-anim-bar-text"></div>
    </div>
</div>

<script>
/* --- VERƒ∞ TABANI --- */
let wins = parseInt(localStorage.getItem('weekWorldWins')) || 0;
let medals = parseInt(localStorage.getItem('weekWorldMedals')) || 0;
let totalSeconds = parseInt(localStorage.getItem('weekWorldPlaytime')) || 0;
let profileData = JSON.parse(localStorage.getItem('weekWorldProfile')) || { name: "Oyuncu", title: "YENƒ∞ OYUNCU", avatar: "https://i.ibb.co/vz6mXmX/default-avatar.png", frame: "", ownedAvatars: ["https://i.ibb.co/vz6mXmX/default-avatar.png"], ownedFrames: [], ownedTitles: ["YENƒ∞ OYUNCU", "GEZGƒ∞N"] };
if (!profileData.ownedMapStyles) profileData.ownedMapStyles = ["Varsayƒ±lan"];
if (!profileData.mapStyle) profileData.mapStyle = "Varsayƒ±lan";

/* --- BA≈ûARIMLAR VERƒ∞ TABANI --- */
let unlockedAchievements = JSON.parse(localStorage.getItem('weekWorldAchievements')) || [];
let spentMedals = parseInt(localStorage.getItem('weekWorldSpentMedals')) || 0;
let streak4500 = parseInt(localStorage.getItem('weekWorldStreak4500')) || 0;

/* --- YENƒ∞ ƒ∞STATƒ∞STƒ∞K TAKƒ∞Bƒ∞ --- */
let gamesPlayed = parseInt(localStorage.getItem('weekWorldGamesPlayed')) || 0;
let totalMedalsEarned = parseInt(localStorage.getItem('weekWorldTotalMedalsEarned')) || medals;
let gamesLost = parseInt(localStorage.getItem('weekWorldGamesLost')) || 0;
let challengesCompleted = parseInt(localStorage.getItem('weekWorldChallengesCompleted')) || 0;

function saveStats() {
    localStorage.setItem('weekWorldGamesPlayed', gamesPlayed);
    localStorage.setItem('weekWorldTotalMedalsEarned', totalMedalsEarned);
    localStorage.setItem('weekWorldGamesLost', gamesLost);
    localStorage.setItem('weekWorldChallengesCompleted', challengesCompleted);
}

function addMedals(amount) {
    medals = parseInt(localStorage.getItem('weekWorldMedals')) || 0;
    medals += amount;
    totalMedalsEarned += amount;
    localStorage.setItem('weekWorldMedals', medals);
    saveStats();
    updateUI();
}

const achievementsData = [
    { id: 'guess_5k', title: '5.000 Puan', desc: 'Harita √ºzerinde 5.000 puanlƒ±k tahmin yap', emoji: 'üéØ', reward: 3 },
    { id: 'atlas_50', title: 'Atlas Uzmanƒ±', desc: 'Oyun √ºzerinde 50 galibiyete ula≈ü!', emoji: 'üó∫Ô∏è', reward: 10 },
    { id: 'map_100', title: 'Harita Yazarƒ±', desc: 'Oyun √ºzerinde 100 galibiyete ula≈ü!', emoji: '‚úçÔ∏è', reward: 20 },
    { id: 'champ_30', title: '≈ûampiyon', desc: 'Meydan okumalardan 30 madalya topla.', emoji: 'üèÜ', reward: 0 },
    { id: 'first_wrong', title: 'ƒ∞lk Yanlƒ±≈ü', desc: 'ƒ∞lk yanlƒ±≈ü tahminini yaptƒ±n.', emoji: '‚ùå', reward: 1 },
    { id: 'first_right', title: 'ƒ∞lk Doƒüru', desc: 'ƒ∞lk doƒüru tahminin yaptƒ±m.', emoji: '‚úÖ', reward: 1 },
    { id: 'blind_20k', title: 'Zifiri Karanlƒ±k', desc: 'K√∂r Atƒ±≈ü modunda 20.000 puan barajƒ±nƒ± a≈ü!', emoji: 'üåë', reward: 5 },
    { id: 'hard_win', title: '√áelik Sinirler', desc: 'Zor Modda (Hardcore) galibiyet al.', emoji: 'üß≠', reward: 5 },
    { id: 'loyal_10h', title: 'Sadƒ±k Oyuncu', desc: 'Toplam 10 saat oynama s√ºresine ula≈ü.', emoji: '‚è≥', reward: 5 },
    { id: 'rich', title: 'Zengin', desc: 'Markette 50 madalya harca.', emoji: 'üí∞', reward: 8 },
    { id: 'unstoppable', title: 'Durmak Yok!', desc: '√úst √ºste 3 ≈üehir tahmininden en az 4500 puan al.', emoji: 'üî•', reward: 8 },
    { id: 'penguin', title: 'Penguenmi G√∂r√ºyorum?', desc: 'Antartika kƒ±tasƒ±nda rastgele bir konumu i≈üaretle.', emoji: 'üêß', reward: 0 },
    { id: 'achv_mid_1', title: 'Hedef Odaklƒ±', desc: '10 kere tam 5000 puan al.', emoji: 'üéØ', reward: 6 },
    { id: 'achv_mid_2', title: 'Kusursuz Seri', desc: '√úst √ºste 5 tahmin 4500 puan √ºst√º yap.', emoji: 'üî•', reward: 6 },
    { id: 'achv_mid_3', title: 'Alƒ±≈üveri≈ü Baƒüƒ±mlƒ±sƒ±', desc: 'Marketten 10 √ºr√ºn al.', emoji: 'üõçÔ∏è', reward: 6 },
    { id: 'achv_mid_4', title: 'D√ºnya Vatanda≈üƒ±', desc: 'Oyunu 20 saat oyna.', emoji: 'üåç', reward: 6 },
    { id: 'achv_mid_5', title: 'Deneyimli', desc: '100 ma√ß tamamla.', emoji: 'üèÖ', reward: 6 },
    { id: 'achv_mid_6', title: 'Gezginin Ruhu', desc: 'Farklƒ± kƒ±talardan 20 ba≈üarƒ±lƒ± tahmin yap.', emoji: 'üß≠', reward: 6 },
    { id: 'achv_mid_7', title: 'Hƒ±z Tutkunu', desc: 'S√ºreli modda 20 ma√ß kazan.', emoji: '‚ö°', reward: 6 },
    { id: 'achv_mid_8', title: 'Usta Sava≈ü√ßƒ±', desc: 'Zor modda 25 ma√ß kazan.', emoji: '‚öîÔ∏è', reward: 6 }
];

/* --- SES MOTORU --- */
let audioCtx = null, musicLoopInterval = null, currentMusicType = null;
let isMusicMuted = localStorage.getItem('weekWorldMuted') === 'true';

function initFirstAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        updateMuteUI();
        if (!isMusicMuted) startLobbyMusic();
    }
}

function updateMuteUI() {
    const btn = document.getElementById('in-menu-music-toggle');
    if(btn) btn.innerText = isMusicMuted ? 'üîá Sesi A√ß' : 'üîä Sesi Kapat';
}

function toggleGlobalMusic(event) {
    if (event) event.stopPropagation();
    isMusicMuted = !isMusicMuted;
    localStorage.setItem('weekWorldMuted', isMusicMuted);
    updateMuteUI();
    if (isMusicMuted) { stopMusic(); } 
    else {
        if (document.getElementById('main-menu').style.visibility !== 'hidden') startLobbyMusic();
        else if (roundActive) startGameMusic();
    }
}

function stopMusic() { 
    if (musicLoopInterval) { clearInterval(musicLoopInterval); musicLoopInterval = null; } 
    currentMusicType = null;
}

function startLobbyMusic() {
    if (isMusicMuted || currentMusicType === 'lobby') return;
    stopMusic(); currentMusicType = 'lobby';
    const masterGain = audioCtx.createGain(); masterGain.gain.setValueAtTime(0, audioCtx.currentTime); masterGain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 2); masterGain.connect(audioCtx.destination);
    let step = 0;
    musicLoopInterval = setInterval(() => { 
        if (isMusicMuted) return; 
        const now = audioCtx.currentTime; 
        const chords = [130.81, 174.61, 196.00, 130.81]; 
        const osc = audioCtx.createOscillator(); 
        const g = audioCtx.createGain(); 
        osc.frequency.setValueAtTime(chords[Math.floor(step / 4) % 4], now); 
        g.gain.setValueAtTime(0, now); 
        g.gain.linearRampToValueAtTime(0.05, now + 1); 
        g.gain.linearRampToValueAtTime(0, now + 3); 
        osc.connect(g); 
        g.connect(masterGain); 
        osc.start(now); 
        osc.stop(now + 4); 
        step++; 
    }, 1000);
}

function startGameMusic() {
    if (isMusicMuted || currentMusicType === 'game') return;
    stopMusic(); currentMusicType = 'game';
    const masterGain = audioCtx.createGain(); masterGain.gain.setValueAtTime(0.1, audioCtx.currentTime); masterGain.connect(audioCtx.destination);
    let step = 0;
    musicLoopInterval = setInterval(() => { 
        if (isMusicMuted) return; 
        const now = audioCtx.currentTime; 
        const arpeggio = [261.63, 329.63, 392.00, 523.25]; 
        const osc = audioCtx.createOscillator(); 
        const g = audioCtx.createGain(); 
        osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(arpeggio[step % 4], now); 
        g.gain.setValueAtTime(0.04, now); 
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.2); 
        osc.connect(g); 
        g.connect(masterGain); 
        osc.start(now); 
        osc.stop(now + 0.2); 
        step++; 
    }, 250);
}

/* YENƒ∞: SAYFA √áEVƒ∞RME SESƒ∞ */
function playPageTurnSound() {
    if (isMusicMuted || !audioCtx) return;
    const duration = 0.35;
    const bufferSize = Math.floor(audioCtx.sampleRate * duration);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
    const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
    const filter = audioCtx.createBiquadFilter(); 
    filter.type = 'lowpass'; filter.frequency.setValueAtTime(800, audioCtx.currentTime);
    filter.frequency.linearRampToValueAtTime(2000, audioCtx.currentTime + duration);
    const gain = audioCtx.createGain(); 
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime); 
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
    noise.start();
}

/* YENƒ∞: KAƒûIT SESƒ∞ (D√ºrb√ºn Sesi Yerine) */
function playPaperSound() {
    if (isMusicMuted || !audioCtx) return;
    const duration = 0.2;
    const bufferSize = Math.floor(audioCtx.sampleRate * duration);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
    const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
    const filter = audioCtx.createBiquadFilter(); 
    filter.type = 'highpass';
    filter.frequency.value = 2000;
    const gain = audioCtx.createGain(); 
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime); 
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
    noise.start();
}

/* XP ANƒ∞MASYONU ƒ∞√áƒ∞N SESLER (Kƒ±sƒ±k Ses) */
function playXPAnimSound(type) {
    if (isMusicMuted || !audioCtx) return;
    const now = audioCtx.currentTime;
    if(type === 'slide') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(300, now + 1.5);
        gain.gain.setValueAtTime(0.01, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
        osc.connect(gain); gain.connect(audioCtx.destination); osc.start();
        osc.stop(now + 1.5);
    } else if(type === 'pop') {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.02, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
        osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(now + 0.5);
    } else if(type === 'shatter') {
        const duration = 0.8;
        const bufferSize = Math.floor(audioCtx.sampleRate * duration);
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
        const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'highpass'; filter.frequency.value = 4000;
        const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.03, now); gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
        noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination); noise.start();
    }
}

function playWindSound(duration) {
    if (isMusicMuted || !audioCtx) return;
    const bufferSize = Math.floor(audioCtx.sampleRate * duration);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
    const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
    const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(400, audioCtx.currentTime);
    filter.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + duration/2);
    const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0.15, audioCtx.currentTime + 0.2); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
    noise.connect(filter); filter.connect(gain);
    gain.connect(audioCtx.destination); noise.start();
}

function playClockTick(isTak = false) {
    if (isMusicMuted || !audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine'; osc.frequency.setValueAtTime(isTak ? 200 : 400, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
    osc.connect(gain);
    gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}

function playScoreTick() {
    if (isMusicMuted || !audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine'; osc.frequency.setValueAtTime(600 + (Math.random()*400), audioCtx.currentTime);
    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
    osc.connect(gain); gain.connect(audioCtx.destination); osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
}

/* --- AYARLAR VE ƒ∞STATƒ∞STƒ∞KLER --- */
function openSettings(event) {
    if(event) event.stopPropagation();
    playPageTurnSound();
    document.getElementById('settings-menu').style.display = 'flex';
    document.getElementById('stat-played').innerText = gamesPlayed;
    document.getElementById('stat-won').innerText = wins;
    document.getElementById('stat-lost').innerText = gamesLost;
    document.getElementById('stat-challenges').innerText = challengesCompleted;
    document.getElementById('stat-earned-medals').innerText = totalMedalsEarned;
    document.getElementById('stat-spent-medals').innerText = spentMedals;
}

function closeSettings() {
    playPageTurnSound();
    document.getElementById('settings-menu').style.display = 'none';
}

/* --- BA≈ûARIM FONKSƒ∞YONLARI --- */
function openAchievements() { document.getElementById('achievement-menu').style.display = 'flex'; renderAchievements(); }
function closeAchievements() { document.getElementById('achievement-menu').style.display = 'none'; }
function renderAchievements() {
    document.getElementById('achv-header').innerText = `Sahip olunan ba≈üarƒ±mlar: ${unlockedAchievements.length}`;
    const grid = document.getElementById('achv-grid'); grid.innerHTML = '';
    achievementsData.forEach(achv => {
        let isUnlocked = unlockedAchievements.includes(achv.id);
        let card = document.createElement('div'); card.className = 'mode-card achv-card drag-area'; card.style.opacity = isUnlocked ? '1' : '0.5';
        card.innerHTML = `<span class="achv-title">${achv.emoji} ${achv.title}</span><span class="mode-desc">${achv.desc}</span>`;
        grid.appendChild(card);
    });
    enableDragScroll('.drag-area');
}

let notifQueue = [];
let isNotifPlaying = false;
function showAchvNotification(achv, isQuest = false) { 
    notifQueue.push({achv, isQuest});
    if (!isNotifPlaying) playNextNotif();
}
function playNextNotif() {
    if (notifQueue.length === 0) { isNotifPlaying = false; return; }
    isNotifPlaying = true;
    let data = notifQueue.shift();
    let achv = data.achv;
    let notifEl = document.getElementById('achv-notification');
    let titleEl = document.getElementById('achv-notif-title');
    let typeEl = document.getElementById('achv-notif-type');
    let medalBadge = document.getElementById('achv-medal-badge');

    typeEl.innerText = data.isQuest ? "G√ñREV TAMAMLANDI" : "BA≈ûARIM KAZANILDI";
    document.getElementById('achv-notif-emoji').innerText = achv.emoji || 'üìú';
    titleEl.innerText = achv.title;
    titleEl.style.opacity = "0";
    if(achv.reward && achv.reward > 0) {
        medalBadge.innerText = `+${achv.reward} üèÜ`;
        medalBadge.style.display = 'block';
    } else {
        medalBadge.style.display = 'none';
    }

    notifEl.style.right = "20px";
    setTimeout(() => {
        titleEl.style.opacity = "1";
        setTimeout(() => {
            notifEl.style.right = "-400px";
            setTimeout(() => { playNextNotif(); }, 600);
        }, 3000);
    }, 600);
}

function unlockAchievement(id) {
    if (!unlockedAchievements.includes(id)) {
        unlockedAchievements.push(id);
        localStorage.setItem('weekWorldAchievements', JSON.stringify(unlockedAchievements));
        let achv = achievementsData.find(a => a.id === id);
        
        if(achv && achv.reward > 0) {
            triggerQuest('d5', achv.reward);
            triggerQuest('w10', achv.reward);
            addMedals(achv.reward);
        }

        if(achv) {
            showAchvNotification(achv, false);
            if(document.getElementById('achievement-menu').style.display === 'flex') renderAchievements();
        }
    }
}

function checkMilestoneAchievements() {
    if (wins >= 50) unlockAchievement('atlas_50');
    if (wins >= 100) unlockAchievement('map_100');
    if (medals >= 30) unlockAchievement('champ_30');
    if (totalSeconds >= 36000) unlockAchievement('loyal_10h');
    if (gamesPlayed >= 100) unlockAchievement('achv_mid_5');
    if (totalSeconds >= 72000) unlockAchievement('achv_mid_4');
}

/* --- MARKET VE E≈ûYA √úRETƒ∞Cƒ∞LERƒ∞ --- */
const createSVG = (color, text) => `data:image/svg+xml;charset=UTF-8,` + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><rect width='150' height='150' fill='#${color}'/><text x='50%' y='50%' font-size='24' fill='white' font-family='Arial' font-weight='bold' text-anchor='middle' dy='.3em'>${text}</text></svg>`);
const createSpecialSVG = (bg, emoji) => `data:image/svg+xml;charset=UTF-8,` + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><rect width='150' height='150' fill='${bg}'/><text x='50%' y='50%' font-size='60' text-anchor='middle' dy='.35em'>${emoji}</text></svg>`);
const coloredProducts = [
    /* PASS √úR√úNLERƒ∞ */
    { id: 't_season1', passOnly: true, type: 'title', name: 'ƒ∞lk Sezon!', titleColor: '#ffffff' },
    { id: 'p_robot', passOnly: true, type: 'photo', name: 'Robot', url: createSpecialSVG('#2c3e50', 'ü§ñ') },
    { id: 't_apprentice', passOnly: true, type: 'title', name: '√áƒ±rak', titleColor: '#aaaaaa' },
    { id: 'f_silver', passOnly: true, type: 'frame', name: 'G√ºm√º≈ü', color: '#c0c0c0' },
    { id: 'p_ninja', passOnly: true, type: 'photo', name: 'Ninja', url: createSpecialSVG('#000000', 'ü•∑') },
    { id: 't_skilled', passOnly: true, type: 'title', name: 'Yetenekli', titleColor: '#8bc34a' },
    { id: 'f_bronze', passOnly: true, type: 'frame', name: 'Bronz', color: '#cd7f32' },
    { id: 'p_dragon', passOnly: true, type: 'photo', name: 'Ejderha', url: createSpecialSVG('#d32f2f', 'üêâ') },
    { id: 't_master', passOnly: true, type: 'title', name: 'Usta', titleColor: '#ff9800' },
    { id: 'f_emerald', passOnly: true, type: 'frame', name: 'Z√ºmr√ºt', color: '#50c878' },
    { id: 't_legendary', passOnly: true, type: 'title', name: 'Efsanevi', titleColor: '#00bcd4' },
    { id: 'p_crown', passOnly: true, type: 'photo', name: 'Kral Tacƒ±', url: createSpecialSVG('#ffb300', 'üëë') },
    { id: 'f_ruby', passOnly: true, type: 'frame', name: 'Yakut', color: '#e0115f' },

    /* MARKET √úR√úNLERƒ∞ */
    { id: 'p_blue', type: 'photo', name: 'Mavi Profil Fotoƒürafƒ±', price: 8, url: createSVG('2962ff', 'Mavi') },
    { id: 'p_green', type: 'photo', name: 'Ye≈üil Profil Fotoƒürafƒ±', price: 8, url: createSVG('00c853', 'Ye≈üil') },
    { id: 'p_red', type: 'photo', name: 'Kƒ±rmƒ±zƒ± Profil Fotoƒürafƒ±', price: 8, url: createSVG('ff3d00', 'Kƒ±rmƒ±zƒ±') },
    { id: 'p_world', type: 'photo', name: 'D√ºnya', price: 12, url: createSpecialSVG('black', 'üåç') },
    { id: 'p_fire', type: 'photo', name: 'Ate≈ü', price: 12, url: createSpecialSVG('orange', 'üî•') },
    { id: 'p_alien', type: 'photo', name: 'Uzaylƒ±', price: 10, url: createSpecialSVG('#111', 'üëΩ') },
    { id: 'p_cat', type: 'photo', name: 'Kedicik', price: 10, url: createSpecialSVG('#ff9800', 'üê±') },
    { id: 'p_dog', type: 'photo', name: 'K√∂pekcik', price: 10, url: createSpecialSVG('#8d6e63', 'üê∂') },
    { id: 'p_fox', type: 'photo', name: 'Kurnaz Tilki', price: 10, url: createSpecialSVG('#ff5722', 'ü¶ä') },
    { id: 'p_ghost', type: 'photo', name: 'Hayalet', price: 10, url: createSpecialSVG('#9e9e9e', 'üëª') },

    { id: 'f_fire', type: 'frame', name: 'Alev √áer√ßevesi', price: 12, color: 'fire_gradient' },
    { id: 'f_blue', type: 'frame', name: 'Mavi Avatar √áer√ßevesi', price: 10, color: '#2962ff' },
    { id: 'f_green', type: 'frame', name: 'Ye≈üil Avatar √áer√ßevesi', price: 10, color: '#00c853' },
    { id: 'f_red', type: 'frame', name: 'Kƒ±rmƒ±zƒ± Avatar √áer√ßevesi', price: 10, color: '#ff3d00' },
    { id: 'f_purple', type: 'frame', name: 'Mor Avatar √áer√ßevesi', price: 10, color: '#9c27b0' },
    { id: 'f_gold', type: 'frame', name: 'Altƒ±n Avatar √áer√ßevesi', price: 10, color: '#ffd700' },
    { id: 'f_cyan', type: 'frame', name: 'Turkuaz Avatar √áer√ßevesi', price: 10, color: '#00bcd4' },
    { id: 'f_pink', type: 'frame', name: 'Pembe Avatar √áer√ßevesi', price: 10, color: '#e91e63' },
    { id: 'f_white', type: 'frame', name: 'Beyaz Avatar √áer√ßevesi', price: 10, color: '#ffffff' },

    { id: 't_rich', type: 'title', name: 'Zengin Oyuncu', price: 15, titleColor: '#ccff00' },
    { id: 't_first', type: 'title', name: 'Birinci', price: 8, titleColor: '#00ffff' },
    { id: 't_worldtour', type: 'title', name: 'D√ºnya Turu', price: 20, isGradient: true, gradient: 'linear-gradient(to right, #2962ff, #00c853)' },
    { id: 't_serialmapper', type: 'title', name: 'Seri Haritacƒ±', price: 18, isGradient: true, gradient: 'linear-gradient(to right, #ff3d00, #8b0000)' },
    { id: 't_legend', type: 'title', name: 'Efsane', price: 10, titleColor: '#ff9800' },
    { id: 't_explorer', type: 'title', name: 'Ka≈üif', price: 10, titleColor: '#4caf50' },
    { id: 't_tourist', type: 'title', name: 'Turist', price: 10, titleColor: '#03a9f4' },
    { id: 't_expert', type: 'title', name: 'Uzman', price: 10, titleColor: '#9c27b0' },
    { id: 't_mapworm', type: 'title', name: 'Harita Kurdu', price: 10, titleColor: '#795548' },

    { id: 'm_dark', type: 'mapStyle', name: 'Karanlƒ±k Harita', price: 30, url: createSpecialSVG('#111', 'üåë') }
];

function initMarket() {
    const grids = { photo: document.getElementById('market-grid-photos'), frame: document.getElementById('market-grid-frames'), title: document.getElementById('market-grid-titles'), mapStyle: document.getElementById('market-grid-maps') };
    Object.values(grids).forEach(g => g.innerHTML = '');
    
    coloredProducts.filter(p => !p.passOnly).forEach(p => {
        let isOwned = (p.type === 'photo' ? profileData.ownedAvatars.includes(p.url) : p.type === 'frame' ? profileData.ownedFrames.includes(p.color) : p.type === 'mapStyle' ? profileData.ownedMapStyles.includes(p.name) : profileData.ownedTitles.includes(p.name));
        const div = document.createElement('div'); div.className = 'market-item drag-area'; let preview = "";
        
        if(p.type === 'frame') preview = `<div class="item-img-preview frame-preview ${p.color === 'fire_gradient' ? 'fire-frame' : ''}" style="${p.color !== 'fire_gradient' ? 'border-color:'+p.color : ''}; margin:auto;"></div>`;
        else if(p.type === 'photo' || p.type === 'mapStyle') preview = `<img src="${p.url}" class="item-img-preview" style="margin:auto;">`;
        else {
            let titleStyle = p.isGradient ? `background: ${p.gradient}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;` : `color:${p.titleColor};`;
            preview = `<div style="${titleStyle} font-weight:bold; height:80px; display:flex; align-items:center; justify-content:center; text-align:center;">${p.name}</div>`;
        }
        
        div.innerHTML = `${preview}<div class="item-name">${p.type === 'title' ? '' : p.name}</div><div class="item-price">üèÜ ${p.price}</div><button class="buy-btn ${isOwned ? 'owned' : ''}" onclick="buyProduct('${p.id}')">${isOwned ? 'SAHƒ∞PSƒ∞N' : 'SATIN AL'}</button>`;
        grids[p.type].appendChild(div);
    });
    enableDragScroll('.drag-area');
}

function buyProduct(id) {
    const p = coloredProducts.find(x => x.id === id); if(!p || medals < p.price) return;
    medals -= p.price; 
    spentMedals += p.price;
    localStorage.setItem('weekWorldSpentMedals', spentMedals);
    
    if (spentMedals >= 50) unlockAchievement('rich');
    triggerQuest('d6'); triggerQuest('d17'); 
    triggerQuest('w12', p.price); triggerQuest('w18');
    let purchasedCount = (parseInt(localStorage.getItem('weekWorldPurchasedItems')) || 0) + 1;
    localStorage.setItem('weekWorldPurchasedItems', purchasedCount);
    if(purchasedCount >= 10) unlockAchievement('achv_mid_3');
    if(p.type === 'title') { let qs = loadQuestState(); qs.w5BoughtTitle = true; saveQuestState(qs); }
    
    if(p.type === 'photo') profileData.ownedAvatars.push(p.url); 
    else if(p.type === 'frame') profileData.ownedFrames.push(p.color);
    else if(p.type === 'mapStyle') profileData.ownedMapStyles.push(p.name);
    else profileData.ownedTitles.push(p.name);
    
    localStorage.setItem('weekWorldMedals', medals); 
    saveStats(); saveProfile(); updateUI(); renderInventory(); initMarket();
}

function renderInventory() {
    const grids = { av: document.getElementById('inv-avatars'), fr: document.getElementById('inv-frames'), ti: document.getElementById('inv-titles'), mp: document.getElementById('inv-maps') };
    Object.values(grids).forEach(g => g.innerHTML = '');
    
    profileData.ownedTitles.forEach(t => { 
        const span = document.createElement('div'); span.className = `title-tag ${profileData.title === t ? 'active' : ''}`; 
        let prod = coloredProducts.find(x => x.name === t);
        if (prod && prod.isGradient) span.innerHTML = `<span style="background: ${prod.gradient}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${t}</span>`;
        else span.innerText = t; 
        span.onclick = () => { profileData.title = t; checkTitleEquip(); renderInventory(); updateUI(); }; grids.ti.appendChild(span); 
    });
    
    profileData.ownedMapStyles.forEach(m => { 
        const span = document.createElement('div'); span.className = `title-tag ${profileData.mapStyle === m ? 'active' : ''}`; span.innerText = m; 
        span.onclick = () => { profileData.mapStyle = m; renderInventory(); updateUI(); }; grids.mp.appendChild(span); 
    });
    profileData.ownedAvatars.forEach(url => { let img = document.createElement('img'); img.src = url; img.className = 'inv-item'; img.style.cssText = `width:60px; height:60px; border-radius:50%; cursor:pointer; border: 3px solid ${profileData.avatar === url ? '#ffcc00' : 'transparent'}; pointer-events: auto;`; img.onclick = () => { profileData.avatar = url; updateUI(); renderInventory(); }; grids.av.appendChild(img); });
    let noFr = document.createElement('div'); noFr.className = 'inv-item'; noFr.style.cssText = `width:54px; height:54px; border-radius:50%; cursor:pointer; border: 3px solid ${profileData.frame === '' ? '#ffcc00' : '#444'}; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); pointer-events: auto;`; noFr.innerHTML = '‚ùå';
    noFr.onclick = () => { profileData.frame = ''; updateUI(); renderInventory(); }; grids.fr.appendChild(noFr);
    profileData.ownedFrames.forEach(c => { let div = document.createElement('div'); div.className = 'inv-item ' + (c === 'fire_gradient' ? 'fire-frame' : ''); div.style.cssText = `width:54px; height:54px; border-radius:50%; cursor:pointer; ${c === 'fire_gradient' ? '' : 'border:4px solid '+c}; box-shadow: ${profileData.frame === c ? '0 0 15px orange' : 'none'}; pointer-events: auto;`; div.onclick = () => { profileData.frame = c; updateUI(); renderInventory(); }; grids.fr.appendChild(div); });
}

function checkTitleEquip() {
    let qs = loadQuestState();
    if(qs.w5BoughtTitle && profileData.title !== 'YENƒ∞ OYUNCU' && profileData.title !== 'GEZGƒ∞N') { triggerQuest('w5'); }
}

function updateUI() {
    document.getElementById('market-medal-count').innerText = medals; document.getElementById('challenge-medal-count').innerText = medals; document.getElementById('display-name').innerText = profileData.name; document.getElementById('display-avatar').src = profileData.avatar;
    const f = document.getElementById('display-frame'); f.className = "avatar-frame"; if(profileData.frame === 'fire_gradient') f.classList.add('fire-frame'); else f.style.border = profileData.frame ? `4px solid ${profileData.frame}` : 'none';
    
    const dTitle = document.getElementById('display-title');
    dTitle.innerText = profileData.title;
    let titleProd = coloredProducts.find(x => x.name === profileData.title);
    if(titleProd && titleProd.isGradient) {
        dTitle.style.background = titleProd.gradient;
        dTitle.style.webkitBackgroundClip = 'text';
        dTitle.style.webkitTextFillColor = 'transparent';
        dTitle.style.color = 'transparent';
    } else {
        dTitle.style.background = 'none';
        dTitle.style.webkitBackgroundClip = 'initial';
        dTitle.style.webkitTextFillColor = 'initial';
        dTitle.style.color = titleProd ? titleProd.titleColor : '#ffcc00';
    }

    document.getElementById('name-input').value = profileData.name;
    let emoji = wins < 20 ? "‚õìÔ∏è" : wins < 40 ? "ü•à" : wins < 60 ? "ü•á" : "üíé"; document.getElementById('rank-emoji').innerText = emoji;
    document.getElementById('rank-name').innerText = wins < 20 ? "Demir" : wins < 40 ? "G√ºm√º≈ü" : wins < 60 ? "Altƒ±n" : "Elmas";
    const ticks = document.getElementById('win-ticks'); ticks.innerHTML = '';
    for(let i=0; i<20; i++) { let t = document.createElement('div'); t.className = 'tick' + (i < (wins % 20) ? ' active' : '');
    ticks.appendChild(t); }
    
    if(document.getElementById('pass-total-xp')) document.getElementById('pass-total-xp').innerText = (parseInt(localStorage.getItem('weekWorldSeasonXP')) || 0);
}

function saveProfile() { localStorage.setItem('weekWorldProfile', JSON.stringify(profileData)); }
function openMarket() { document.getElementById('market-menu').style.display = 'flex'; initMarket(); updateUI(); }
function closeMarket() { document.getElementById('market-menu').style.display = 'none'; }
function openChallenges() { document.getElementById('challenge-menu').style.display = 'flex'; updateUI(); }
function closeChallenges() { document.getElementById('challenge-menu').style.display = 'none'; }
function openProfileEdit() { document.getElementById('profile-edit-menu').style.display = 'flex'; renderInventory(); }
function closeProfileEdit() { 
    let newName = document.getElementById('name-input').value;
    if(newName !== profileData.name) { triggerQuest('d12'); triggerQuest('w24'); }
    else { triggerQuest('d12'); } 
    profileData.name = newName || profileData.name; 
    saveProfile(); updateUI();
    document.getElementById('profile-edit-menu').style.display = 'none';
}

/* --- SEZON Bƒ∞LETƒ∞ Sƒ∞STEMƒ∞ --- */
const passRewardsData = [
    { tier: 1, itemType: 'title', prodId: 't_season1', label: 'ƒ∞lk Sezon!', display: `<div style="color:white; font-weight:bold; font-size:1.2rem;">ƒ∞lk Sezon!</div>` },
    { tier: 2, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 3, itemType: 'photo', prodId: 'p_robot', label: 'Robot Fotoƒürafƒ±', display: `<img src="${createSpecialSVG('#2c3e50', 'ü§ñ')}" style="width:70px; border-radius:10px;">` },
    { tier: 4, itemType: 'title', prodId: 't_apprentice', label: '√áƒ±rak √únvanƒ±', display: `<div style="color:#aaaaaa; font-weight:bold; font-size:1.2rem;">√áƒ±rak</div>` },
    { tier: 5, itemType: 'medal', amount: 5, label: '5 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 6, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 7, itemType: 'frame', prodId: 'f_silver', label: 'G√ºm√º≈ü √áer√ßeve', display: `<div style="width:60px; height:60px; border-radius:50%; border:4px solid #c0c0c0; margin:auto;"></div>` },
    { tier: 8, itemType: 'photo', prodId: 'p_ninja', label: 'Ninja Fotoƒürafƒ±', display: `<img src="${createSpecialSVG('#000000', 'ü•∑')}" style="width:70px; border-radius:10px;">` },
    { tier: 9, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 10, itemType: 'medal', amount: 5, label: '5 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 11, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 12, itemType: 'title', prodId: 't_skilled', label: 'Yetenekli √únvanƒ±', display: `<div style="color:#8bc34a; font-weight:bold; font-size:1.2rem;">Yetenekli</div>` },
    { tier: 13, itemType: 'frame', prodId: 'f_bronze', label: 'Bronz √áer√ßeve', display: `<div style="width:60px; height:60px; border-radius:50%; border:4px solid #cd7f32; margin:auto;"></div>` },
    { tier: 14, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 15, itemType: 'medal', amount: 5, label: '5 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 16, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 17, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 18, itemType: 'photo', prodId: 'p_dragon', label: 'Ejderha Fotoƒürafƒ±', display: `<img src="${createSpecialSVG('#d32f2f', 'üêâ')}" style="width:70px; border-radius:10px;">` },
    { tier: 19, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 20, itemType: 'medal', amount: 5, label: '5 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 21, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 22, itemType: 'title', prodId: 't_legendary', label: 'Efsanevi √únvanƒ±', display: `<div style="color:#00bcd4; font-weight:bold; font-size:1.2rem;">Efsanevi</div>` },
    { tier: 23, itemType: 'frame', prodId: 'f_emerald', label: 'Z√ºmr√ºt √áer√ßeve', display: `<div style="width:60px; height:60px; border-radius:50%; border:4px solid #50c878; margin:auto;"></div>` },
    { tier: 24, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 25, itemType: 'medal', amount: 5, label: '5 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 26, itemType: 'medal', amount: 2, label: '2 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` },
    { tier: 27, itemType: 'title', prodId: 't_master', label: 'Usta √únvanƒ±', display: `<div style="color:#ff9800; font-weight:bold; font-size:1.2rem;">Usta</div>` },
    { tier: 28, itemType: 'photo', prodId: 'p_crown', label: 'Kral Tacƒ±', display: `<img src="${createSpecialSVG('#ffb300', 'üëë')}" style="width:70px; border-radius:10px;">` },
    { tier: 29, itemType: 'frame', prodId: 'f_ruby', label: 'Yakut √áer√ßeve', display: `<div style="width:60px; height:60px; border-radius:50%; border:4px solid #e0115f; margin:auto;"></div>` },
    { tier: 30, itemType: 'medal', amount: 5, label: '5 Madalya', display: `<div style="font-size:3rem;">üèÜ</div>` }
];

function openSeasonPass() {
    document.getElementById('season-pass-menu').style.display = 'flex';
    updateUI(); renderSeasonPass();
}

function closeSeasonPass() { document.getElementById('season-pass-menu').style.display = 'none'; }

function renderSeasonPass() {
    let xp = parseInt(localStorage.getItem('weekWorldSeasonXP')) || 0;
    let claimed = JSON.parse(localStorage.getItem('weekWorldSeasonClaimed')) || [];
    let grid = document.getElementById('pass-grid');
    grid.innerHTML = '';
    
    passRewardsData.forEach((r, idx) => {
        let requiredXP = (r.tier - 1) * 1000;
        let isUnlocked = xp >= requiredXP;
        let isClaimed = claimed[idx] === true;
        let isCurrentWorking = (!isUnlocked && r.tier === Math.floor(xp / 1000) + 2);
        
        let btnHtml = '';
        if(isClaimed) {
            btnHtml = `<button class="buy-btn" disabled style="background:#444; color:#aaa;">ALINDI</button>`;
        } else if(isUnlocked) {
            btnHtml = `<button class="buy-btn" style="background:#00c853;" onclick="claimPassReward(${idx})">√ñD√úL√ú AL</button>`;
        } else if(isCurrentWorking) {
            let currentTierXP = xp % 1000;
            let perc = (currentTierXP / 1000) * 100;
            btnHtml = `
                <div style="background:#222; border-radius:8px; height:36px; position:relative; overflow:hidden; border: 1px solid #444;">
                    <div style="width:${perc}%; height:100%; background:#ffcc00; transition: width 0.3s;"></div>
                    <div style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; color:white; text-shadow: 1px 1px 2px black;">
                        ${currentTierXP} / 1000
                    </div>
                </div>`;
        } else {
            btnHtml = `<button class="buy-btn" disabled style="background:#333;"><span style="font-size:1.2rem;">üîí</span> Kƒ∞Lƒ∞TLƒ∞</button>`;
        }
        
        let card = document.createElement('div');
        card.className = `pass-tier ${isUnlocked && !isClaimed ? 'unlocked' : ''} ${isClaimed ? 'claimed' : ''}`;
        card.innerHTML = `
            <div class="tier-level ${isUnlocked ? 'unlocked' : ''}">KADEME ${r.tier}</div>
            <div class="tier-xp">${r.tier === 1 ? 'BA≈ûLANGI√á' : '1000 XP (Kademe Hedefi)'}</div>
            <div style="height:100px; display:flex; align-items:center; justify-content:center; margin-bottom:15px;">
                ${r.display}
            </div>
            <div style="font-weight:bold; margin-bottom:15px; color:#ddd; font-size:14px;">${r.label}</div>
            ${btnHtml}
        `;
        grid.appendChild(card);
    });
    enableDragScroll('.drag-area');
}

function claimPassReward(index) {
    let r = passRewardsData[index];
    let xp = parseInt(localStorage.getItem('weekWorldSeasonXP')) || 0;
    if (xp < (r.tier - 1) * 1000) return;
    
    let claimed = JSON.parse(localStorage.getItem('weekWorldSeasonClaimed')) || [];
    if(claimed[index]) return;
    
    if(r.itemType === 'medal') {
        addMedals(r.amount);
    } else {
        let prod = coloredProducts.find(p => p.id === r.prodId);
        if(prod) {
            if(prod.type === 'photo' && !profileData.ownedAvatars.includes(prod.url)) profileData.ownedAvatars.push(prod.url);
            if(prod.type === 'frame' && !profileData.ownedFrames.includes(prod.color)) profileData.ownedFrames.push(prod.color);
            if(prod.type === 'title' && !profileData.ownedTitles.includes(prod.name)) profileData.ownedTitles.push(prod.name);
            saveProfile(); renderInventory();
        }
    }
    
    claimed[index] = true;
    localStorage.setItem('weekWorldSeasonClaimed', JSON.stringify(claimed));
    renderSeasonPass();
    updateUI();
}

function updatePassTimer() {
    let end = new Date("2026-04-01T00:00:00").getTime();
    let now = new Date().getTime();
    let diff = end - now;
    if (diff < 0) diff = 0;
    let d = Math.floor(diff / 86400000);
    let h = Math.floor((diff % 86400000) / 3600000);
    let timerEl = document.getElementById('pass-timer');
    if (timerEl) timerEl.innerText = `Sezonun bitmesine kalan zaman: ${d} g√ºn ${h} saat`;
}
setInterval(updatePassTimer, 60000); updatePassTimer();

/* --- G√ñREV Sƒ∞STEMƒ∞ --- */
const ALL_DAILY_QUESTS = [
    { id: 'd1', title: '3 Ma√ß Kazan', desc: 'Herhangi bir oyun modunda 3 kez galibiyet elde et.', emoji: 'üèÖ', reward: 2, target: 3 },
    { id: 'd2', title: '5.000 Puan', desc: 'Herhangi bir oyun modunda 5.000 puanlƒ±k bir tahmin yap.', emoji: 'üéØ', reward: 2, target: 1 },
    { id: 'd3', title: 'Avrupa Ka√ßkƒ±nƒ±', desc: 'Avrupa kƒ±tasƒ±ndan herhangi bir ≈üehir tahmininden minimum 4500 puan kazan.', emoji: 'üá™üá∫', reward: 2, target: 1 },
    { id: 'd4', title: 'G√ºn√ºn 24\'te Biri', desc: 'Oyunu bir saat boyunca oyna.', emoji: '‚è±Ô∏è', reward: 2, target: 3600 },
    { id: 'd5', title: 'Pazarcƒ±', desc: 'Herhangi bir yerden 10 madalya kazan.', emoji: 'üõçÔ∏è', reward: 2, target: 10 },
    { id: 'd6', title: 'Alƒ±cƒ±yƒ±m!', desc: 'Marketten en az 2 √ºr√ºn al.', emoji: 'üõí', reward: 2, target: 2 },
    { id: 'd7', title: 'Kiraz √ái√ßekleri', desc: 'Japonya √ºlkesinden bir tahmin yaparak en az 4000 puan kazan.', emoji: 'üå∏', reward: 2, target: 1 },
    { id: 'd8', title: '√úrk√ºt√ºc√º!', desc: 'K√∂r atƒ±≈ü meydan okumasƒ±nda √ºst √ºste 3 tahminden en az 3000 puan topla.', emoji: 'üëª', reward: 2, target: 3 },
    { id: 'd9', title: 'Yeni Nesil!', desc: 'Her oyun modundan ve meydan okumadan en az 1 galibiyet al.', emoji: 'üåü', reward: 2, target: 5 },
    { id: 'd10', title: 'Orman Kokusu Gelmedi mi?', desc: 'G√ºney amerika kƒ±tasƒ±ndan bir tahminde en az 4500 puan topla.', emoji: 'üå≥', reward: 2, target: 1 },
    { id: 'd11', title: 'Psikolojisi Bozuk!', desc: 'Be≈ü tane meydan okuma tamamla.', emoji: 'ü§™', reward: 2, target: 5 },
    { id: 'd12', title: 'Daha mƒ± ƒ∞yi Oldu Sanki?', desc: 'Profilinden bir ≈üeyi deƒüi≈ütir.', emoji: 'üé≠', reward: 2, target: 1 },
    { id: 'd13', title: 'ƒ∞lk Adƒ±m', desc: '1 Ma√ß oyna.', emoji: 'üö∂', reward: 2, target: 1 },
    { id: 'd14', title: 'Uzman Atƒ±≈üƒ±', desc: 'Tek seferde 3000 puanlƒ±k tahmin yap.', emoji: 'üéØ', reward: 2, target: 1 },
    { id: 'd15', title: 'Asya Esintisi', desc: 'Asya kƒ±tasƒ±ndan bir ≈üehri bil.', emoji: 'üåè', reward: 2, target: 1 },
    { id: 'd16', title: 'Amerika Yolcusu', desc: 'Kuzey Amerika kƒ±tasƒ±ndan bir ≈üehri bil.', emoji: 'üåé', reward: 2, target: 1 },
    { id: 'd17', title: 'Alƒ±≈üveri≈ü Vakti', desc: 'Marketten 1 √ºr√ºn al.', emoji: 'üõí', reward: 2, target: 1 },
    { id: 'd18', title: 'Seri Atƒ±≈ü', desc: 'Ardƒ±≈üƒ±k 2 tahminden en az 4000 puan al.', emoji: 'üî•', reward: 2, target: 2 },
    { id: 'd19', title: 'Klasik√ßi', desc: 'D√ºnya modunda 1 ma√ß oyna.', emoji: 'üåç', reward: 2, target: 1 },
    { id: 'd20', title: 'Hƒ±zlƒ± ve √ñfkeli', desc: 'S√ºreli modda 1 ma√ß oyna.', emoji: '‚è±Ô∏è', reward: 2, target: 1 },
    { id: 'd21', title: 'Avcƒ±', desc: 'Zor modda 1 ma√ß kazan.', emoji: 'üß≠', reward: 2, target: 1 },
    { id: 'd22', title: 'G√∂zlemci', desc: 'K√∂r Atƒ±≈üta 1 tahmin yap.', emoji: 'üåë', reward: 2, target: 1 }
];

const ALL_WEEKLY_QUESTS = [
    { id: 'w1', title: 'Zor Mod ≈ûampiyonu!', desc: 'Zor modda 10 galibiyet al.', emoji: '‚ò†Ô∏è', reward: 5, target: 10 },
    { id: 'w2', title: 'Zamanla Yarƒ±≈ü', desc: 'S√ºreli modda 30 tane minimum 4.500 puanlƒ±k tahmin yap.', emoji: 'üèéÔ∏è', reward: 5, target: 30 },
    { id: 'w3', title: 'K√∂r Noktlar...', desc: 'K√∂r atƒ±≈ü meydan okumasƒ±nda 10 ma√ß bitir (Kazan).', emoji: 'üï∂Ô∏è', reward: 5, target: 10 },
    { id: 'w4', title: 'Maratoncu', desc: 'Toplam s√ºre meydan okumasƒ±nda s√ºre 01:00 dakikanƒ±n √ºzerindeyken 10 galibiyet al.', emoji: 'üèÉ', reward: 5, target: 10 },
    { id: 'w5', title: 'Koleksiyoncu', desc: 'Markette satƒ±lan √ºnvanlardan rastgele birini satƒ±n al ve profilinde kullan.', emoji: 'üè∑Ô∏è', reward: 5, target: 1 },
    { id: 'w6', title: 'Stil Sahibi.', desc: 'Envanterinden farklƒ± bir "Harita Stili" se√ßerek bir oyun tamamla.', emoji: 'üó∫Ô∏è', reward: 5, target: 1 },
    { id: 'w7', title: 'Seviyorum Bu Oyunu!', desc: 'Be≈ü saat boyunca oyna.', emoji: '‚ù§Ô∏è', reward: 5, target: 18000 },
    { id: 'w8', title: 'ƒ∞sabet Canavarƒ±!', desc: '25 Tane en az 4500 puanlƒ±k tahmin yap.', emoji: 'üèπ', reward: 5, target: 25 },
    { id: 'w9', title: 'Kƒ±ta Gezgini.', desc: 'Her kƒ±tadan en az 5 kere minimum 4500 puanlƒ±k bir tahmin yap', emoji: '‚úàÔ∏è', reward: 5, target: 6 },
    { id: 'w10', title: 'Madalya Avcƒ±sƒ±.', desc: '30 Madalya topla.', emoji: 'ü•á', reward: 5, target: 30 },
    { id: 'w11', title: 'Usta Haritacƒ±', desc: 'Herhangi bir oyun modunda 50 ma√ß tamamla.', emoji: 'üß≠', reward: 5, target: 50 },
    { id: 'w12', title: 'Zenginliƒüe Doƒüru', desc: 'Markette toplam 100 madalya harca.', emoji: 'üí∏', reward: 5, target: 100 },
    { id: 'w13', title: 'Seri Katil', desc: '√úst √ºste 10 tahminde en az 4500 puan al.', emoji: 'üî™', reward: 5, target: 10 },
    { id: 'w14', title: 'Kusursuz Tahminci', desc: 'Tam olarak 5000 puanlƒ±k 15 tahmin yap.', emoji: 'üíé', reward: 5, target: 15 },
    { id: 'w15', title: 'Hafta Sonu Sava≈ü√ßƒ±sƒ±', desc: 'Klasik D√ºnya Modunda 25 galibiyet al.', emoji: '‚öîÔ∏è', reward: 5, target: 25 },
    { id: 'w16', title: '≈ûehir Plancƒ±sƒ±', desc: 'Toplam 50 tahmin yap.', emoji: 'üèôÔ∏è', reward: 5, target: 50 },
    { id: 'w17', title: 'Atlas Fatihi', desc: 'D√ºnya modunda 5 ma√ß kazan.', emoji: 'üó∫Ô∏è', reward: 5, target: 5 },
    { id: 'w18', title: 'Para Babasƒ±', desc: 'Marketten toplam 5 √ºr√ºn al.', emoji: 'üí∞', reward: 5, target: 5 },
    { id: 'w19', title: 'Kaybetmek Yok', desc: 'Hi√ß hata yapmadan 5 ma√ß bitir (Kazan).', emoji: 'üõ°Ô∏è', reward: 5, target: 5 },
    { id: 'w20', title: 'Afrika Safarisi', desc: 'Afrika kƒ±tasƒ±ndan 5 tahmin yap.', emoji: 'ü¶Å', reward: 5, target: 5 },
    { id: 'w21', title: 'Hƒ±zlƒ± √áekim', desc: 'S√ºreli Modda 10 ma√ß kazan.', emoji: 'üî´', reward: 5, target: 10 },
    { id: 'w22', title: 'Zorlu Yollar', desc: 'Zor modda 50 tahmin yap.', emoji: 'üßó', reward: 5, target: 50 },
    { id: 'w23', title: 'ƒ∞nat√ßƒ±', desc: 'Oyunu toplam 10 saat oyna.', emoji: 'üï∞Ô∏è', reward: 5, target: 36000 },
    { id: 'w24', title: 'Deƒüi≈üim ≈ûart', desc: 'Profil adƒ±nƒ± deƒüi≈ütir.', emoji: 'üîÑ', reward: 5, target: 1 },
    { id: 'w25', title: 'Usta Ka≈üif', desc: '20.000 puanlƒ±k tahmin barajƒ±nƒ± a≈ü (Tek ma√ß).', emoji: 'üåü', reward: 5, target: 1 },
    { id: 'w26', title: 'D√ºnya Turu', desc: 'Her kƒ±tadan 10\'ar tahmin yap.', emoji: '‚úàÔ∏è', reward: 5, target: 6 },
    { id: 'w27', title: 'Nokta Atƒ±≈üƒ±', desc: 'Tam tamƒ±na 5000 puanlƒ±k 25 tahmin.', emoji: 'üéØ', reward: 5, target: 25 },
    { id: 'w28', title: 'Sabƒ±rlƒ±', desc: 'Toplam s√ºre meydan okumasƒ±nda 5 ma√ß kazan.', emoji: '‚è≥', reward: 5, target: 5 },
    { id: 'w29', title: 'G√∂rev Adamƒ±', desc: '10 tane g√∂rev tamamla.', emoji: 'üìã', reward: 5, target: 10 },
    { id: 'w30', title: 'Zirveye Tƒ±rmanƒ±≈ü', desc: '10 Meydan okuma kazan.', emoji: 'üèîÔ∏è', reward: 5, target: 10 }
];

function loadQuestState() {
    let def = { 
        dailyDayId: -1, weeklyWeekId: -1, 
        dailyProgress: [0,0,0], weeklyProgress: [0,0,0,0,0], 
        dailyClaimed: [false,false,false], weeklyClaimed: [false,false,false,false,false],
        d8Streak: 0, d18Streak: 0, d9Modes: [], w9Continents: {EU:0, AS:0, NA:0, SA:0, AF:0, OC:0}, w13Streak: 0, w5BoughtTitle: false
    };
    let qs = JSON.parse(localStorage.getItem('weekWorldQuests'));
    if (!qs) return def;
    if (!qs.w9Continents) qs.w9Continents = {EU:0, AS:0, NA:0, SA:0, AF:0, OC:0};
    if (!qs.d9Modes) qs.d9Modes = [];
    if (qs.d8Streak === undefined) qs.d8Streak = 0;
    if (qs.d18Streak === undefined) qs.d18Streak = 0;
    if (qs.w13Streak === undefined) qs.w13Streak = 0;
    if (qs.w5BoughtTitle === undefined) qs.w5BoughtTitle = false;
    return qs;
}
function saveQuestState(qs) { localStorage.setItem('weekWorldQuests', JSON.stringify(qs)); }

function getResetTimes() {
    let now = new Date();
    let dailyReset = new Date(now); dailyReset.setHours(6,0,0,0);
    if(now.getTime() >= dailyReset.getTime()) dailyReset.setDate(dailyReset.getDate() + 1);
    
    let weeklyReset = new Date(now); weeklyReset.setHours(6,0,0,0);
    let dayOfWeek = weeklyReset.getDay();
    let daysToMonday = (1 - dayOfWeek + 7) % 7;
    if (daysToMonday === 0 && now.getTime() >= weeklyReset.getTime()) daysToMonday = 7;
    weeklyReset.setDate(weeklyReset.getDate() + daysToMonday);
    let dayId = Math.floor((now.getTime() - (6 * 3600000)) / 86400000);
    let weekId = Math.floor((now.getTime() - (3 * 86400000) - (6 * 3600000)) / 604800000);
    return { dailyReset, weeklyReset, dayId, weekId };
}

function updateQuestLogic() {
    let qs = loadQuestState();
    let times = getResetTimes();

    if (qs.dailyDayId !== times.dayId) {
        qs.dailyDayId = times.dayId;
        qs.dailyProgress = [0,0,0]; qs.dailyClaimed = [false,false,false];
        qs.d8Streak = 0; qs.d18Streak = 0; qs.d9Modes = [];
        saveQuestState(qs);
    }
    if (qs.weeklyWeekId !== times.weekId) {
        qs.weeklyWeekId = times.weekId;
        qs.weeklyProgress = [0,0,0,0,0]; qs.weeklyClaimed = [false,false,false,false,false];
        qs.w9Continents = {EU:0, AS:0, NA:0, SA:0, AF:0, OC:0}; qs.w13Streak = 0; qs.w5BoughtTitle = false;
        saveQuestState(qs);
    }
}

function getActiveQuests() {
    updateQuestLogic();
    let qs = loadQuestState();
    let dailyTotalSets = Math.ceil(ALL_DAILY_QUESTS.length / 3);
    let weeklyTotalSets = Math.ceil(ALL_WEEKLY_QUESTS.length / 5);
    
    let dailyIndex = Math.abs(qs.dailyDayId) % dailyTotalSets;
    let weeklyIndex = Math.abs(qs.weeklyWeekId) % weeklyTotalSets;
    let activeDaily = ALL_DAILY_QUESTS.slice(dailyIndex * 3, dailyIndex * 3 + 3).filter(Boolean);
    let activeWeekly = ALL_WEEKLY_QUESTS.slice(weeklyIndex * 5, weeklyIndex * 5 + 5).filter(Boolean);
    
    return { activeDaily, activeWeekly, qs };
}

function triggerQuest(id, amount = 1) {
    let { activeDaily, activeWeekly, qs } = getActiveQuests();
    let isDaily = id.startsWith('d');
    let activeList = isDaily ? activeDaily : activeWeekly;
    let progressList = isDaily ? qs.dailyProgress : qs.weeklyProgress;
    let index = activeList.findIndex(q => q.id === id);
    
    if (index !== -1) {
        let q = activeList[index];
        if (progressList[index] < q.target) {
            progressList[index] = Math.min(q.target, progressList[index] + amount);
            saveQuestState(qs);
            if (progressList[index] >= q.target && !(isDaily ? qs.dailyClaimed[index] : qs.weeklyClaimed[index])) {
                showAchvNotification({ title: q.title, emoji: q.emoji, reward: 0 }, true);
                triggerQuest('w29', 1); 
            }
            if (document.getElementById('quest-menu').style.display === 'flex') renderQuests();
        }
    }
}

function claimQuest(type, index) {
    let { activeDaily, activeWeekly, qs } = getActiveQuests();
    let isDaily = type === 'daily';
    let q = isDaily ? activeDaily[index] : activeWeekly[index];
    
    if (isDaily) qs.dailyClaimed[index] = true;
    else qs.weeklyClaimed[index] = true;
    
    saveQuestState(qs);
    addMedals(q.reward);
    triggerQuest('d5', q.reward); triggerQuest('w10', q.reward);
    updateUI(); renderQuests();
}

function openQuests() { document.getElementById('quest-menu').style.display = 'flex'; renderQuests(); updateQuestTimers(); }
function closeQuests() { document.getElementById('quest-menu').style.display = 'none'; }

function renderQuests() {
    let { activeDaily, activeWeekly, qs } = getActiveQuests();
    const buildHtml = (q, progress, claimed, type, i) => {
        let perc = Math.min(100, (progress / q.target) * 100);
        let completed = progress >= q.target;
        let btnHtml = completed && !claimed ? `<button class="quest-claim-btn" onclick="claimQuest('${type}', ${i})">√ñD√úL√ú AL</button>` : (claimed ? `<button class="quest-claim-btn" disabled>ALINDI</button>` : '');
        return `
            <div class="quest-item ${completed ? 'completed' : ''} ${claimed ? 'claimed' : ''}" title="${q.desc}">
                <div class="quest-emoji">${q.emoji}</div>
                <div class="quest-details">
                    <div class="quest-title">${q.title} <span style="font-size: 0.8rem; font-weight: normal; color:#aaa;">(${progress}/${q.target})</span></div>
                    <div class="quest-desc">${q.desc}</div>
                    <div class="quest-progress-bar-bg"><div class="quest-progress-bar-fill" style="width: ${perc}%;"></div></div>
                </div>
                <div class="quest-reward">+${q.reward} üèÜ</div>
                ${btnHtml}
            </div>
         `;
    };

    document.getElementById('daily-quest-list').innerHTML = activeDaily.map((q, i) => buildHtml(q, qs.dailyProgress[i] || 0, qs.dailyClaimed[i], 'daily', i)).join('');
    document.getElementById('weekly-quest-list').innerHTML = activeWeekly.map((q, i) => buildHtml(q, qs.weeklyProgress[i] || 0, qs.weeklyClaimed[i], 'weekly', i)).join('');
    enableDragScroll('.drag-area');
}

setInterval(updateQuestTimers, 1000);
function updateQuestTimers() {
    if(document.getElementById('quest-menu').style.display !== 'flex') return;
    let times = getResetTimes();
    let now = new Date().getTime();
    let dDiff = times.dailyReset.getTime() - now;
    let dH = Math.floor((dDiff % 86400000) / 3600000);
    let dM = Math.floor((dDiff % 3600000) / 60000);
    let dS = Math.floor((dDiff % 60000) / 1000);
    document.getElementById('daily-timer').innerText = `Yenilenmeye Kalan S√ºre: ${String(dH).padStart(2,'0')}:${String(dM).padStart(2,'0')}:${String(dS).padStart(2,'0')}`;

    let wDiff = times.weeklyReset.getTime() - now;
    let wD = Math.floor(wDiff / 86400000);
    let wH = Math.floor((wDiff % 86400000) / 3600000);
    let wM = Math.floor((wDiff % 3600000) / 60000);
    document.getElementById('weekly-timer').innerText = `Yenilenmeye Kalan S√ºre: ${wD} G√ºn ${String(wH).padStart(2,'0')}:${String(wM).padStart(2,'0')}`;
}

// DRAG TO SCROLL MANTIƒûI
function enableDragScroll(selector) {
    const elements = document.querySelectorAll(selector);
    elements.forEach(slider => {
        let isDown = false, startX, startY, scrollLeft, scrollTop;
        slider.style.cursor = 'grab';
        slider.addEventListener('mousedown', (e) => {
            isDown = true; slider.style.cursor = 'grabbing';
            startX = e.pageX - slider.offsetLeft; startY = e.pageY - slider.offsetTop;
            scrollLeft = slider.scrollLeft; scrollTop = slider.scrollTop;
         });
        slider.addEventListener('mouseleave', () => { isDown = false; slider.style.cursor = 'grab'; });
        slider.addEventListener('mouseup', () => { isDown = false; slider.style.cursor = 'grab'; });
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft; const y = e.pageY - slider.offsetTop;
             const walkX = (x - startX) * 1.5; const walkY = (y - startY) * 1.5;
            slider.scrollLeft = scrollLeft - walkX; slider.scrollTop = scrollTop - walkY;
});
    });
}

// Helper: Get Continent
function getContinent(cityName) {
    if(["Londra", "Paris", "Berlin", "Roma", "Madrid", "Moskova", "Amsterdam", "Br√ºksel", "Viyana", "Atina", "Stokholm", "Var≈üova", "Prag", "Budape≈üte", "Helsinki", "Oslo", "Kopenhag", "Z√ºrih", "Dublin", "Reykjavik", "B√ºkre≈ü", "Belgrad", "Sofya", "Kiev", "ƒ∞stanbul"].includes(cityName)) return 'EU';
    if(["Tokyo", "Dubai", "Pekin", "Seul", "Bangkok", "Singapur", "Yeni Delhi", "Kuala Lumpur", "Manila", "Cakarta", "Hanoi", "Taipei", "Bak√º", "Tiflis", "Astana", "Amman", "Beyrut", "Riyad", "Tel Aviv", "Ankara", "ƒ∞zmir", "Antalya"].includes(cityName)) return 'AS';
    if(["New York", "Toronto", "Los Angeles", "Meksika City"].includes(cityName)) return 'NA';
    if(["Rio de Janeiro", "Buenos Aires", "Santiago", "Lima", "Bogota"].includes(cityName)) return 'SA';
    if(["Kahire", "Cape Town", "Lagos", "Nairobi", "Kazablanka"].includes(cityName)) return 'AF';
    if(["Sidney", "Perth"].includes(cityName)) return 'OC';
    return 'UNKNOWN';
}

/* --- ≈ûEHƒ∞RLER --- */
var citiesEasy = [["ƒ∞stanbul", 41.00, 28.97], ["Ankara", 39.93, 32.85], ["ƒ∞zmir", 38.41, 27.12], ["Antalya", 36.89, 30.71], ["Londra", 51.50, -0.12], ["Paris", 48.85, 2.35], ["Berlin", 52.52, 13.40], ["Roma", 41.90, 12.49], ["Madrid", 40.41, -3.70], ["Tokyo", 35.67, 139.65], ["New York", 40.71, -74.00], ["Sidney", -33.86, 151.20], ["Moskova", 55.75, 37.61], ["Dubai", 25.20, 55.27], ["Amsterdam", 52.36, 4.89], ["Br√ºksel", 50.85, 4.35], ["Viyana", 48.20, 16.37], ["Atina", 37.98, 23.72], ["Kahire", 30.04, 31.23], ["Pekin", 39.90, 116.40], ["Seul", 37.56, 126.97], ["Rio de Janeiro", -22.90, -43.17], ["Buenos Aires", -34.60, -58.38], ["Toronto", 43.65, -79.38], ["Los Angeles", 34.05, -118.24], ["Meksika City", 19.43, -99.13], ["Bangkok", 13.75, 100.50], ["Singapur", 1.35, 103.81], ["Lizbon", 38.72, -9.13], ["Stokholm", 59.32, 18.06]];
var citiesHard = [["Var≈üova", 52.22, 21.01], ["Prag", 50.07, 14.43], ["Budape≈üte", 47.49, 19.04], ["Cape Town", -33.92, 18.42], ["Helsinki", 60.16, 24.93], ["Oslo", 59.91, 10.75], ["Kopenhag", 55.67, 12.56], ["Z√ºrih", 47.37, 8.54], ["Dublin", 53.34, -6.26], ["Reykjavik", 64.12, -21.82], ["Yeni Delhi", 28.61, 77.20], ["Kuala Lumpur", 3.13, 101.68], ["Manila", 14.59, 120.98], ["Cakarta", -6.20, 106.84], ["Santiago", -33.44, -70.66], ["Lima", -12.04, -77.04], ["Bogota", 4.71, -74.07], ["Hanoi", 21.02, 105.83], ["Taipei", 25.03, 121.56], ["B√ºkre≈ü", 44.42, 26.10], ["Belgrad", 44.78, 20.44], ["Sofya", 42.69, 23.32], ["Lagos", 6.52, 3.37], ["Nairobi", -1.29, 36.82], ["Kazablanka", 33.57, -7.58], ["Bak√º", 40.40, 49.86], ["Tiflis", 41.71, 44.78], ["Astana", 51.16, 71.47], ["Amman", 31.94, 35.92], ["Beyrut", 33.89, 35.50], ["Riyad", 24.71, 46.67], ["Tel Aviv", 32.08, 34.78], ["Kiev", 50.45, 30.52], ["Perth", -31.95, 115.86]];

/* --- OYUN MANTIƒûI --- */
var map = L.map('map', {zoomControl: false, attributionControl: false, worldCopyJump: true}).setView([20,0], 3);
var baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
var blindLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png');
var darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
var darkBlindLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png');

if (profileData && profileData.mapStyle === 'Karanlƒ±k Harita') darkLayer.addTo(map);
else baseLayer.addTo(map);

var selectedCity, guessMarker=null, realMarker=null, line=null, score=0, timeLeft=120, roundActive=false, currentMode='normal', timerInterval, nextRoundInterval;

function startCountdown(mode) {
    currentMode = mode; document.getElementById('main-menu').style.visibility = 'hidden'; document.getElementById('challenge-menu').style.display = 'none'; document.getElementById('settings-toggle').style.display = 'none';
    const overlay = document.getElementById('start-countdown-overlay'); overlay.style.display = 'flex'; stopMusic();
    
    triggerQuest('d13'); triggerQuest('w16'); 
    if(mode === 'normal') triggerQuest('d19');
    if(mode === 'speedrun') triggerQuest('d20');

    let c = 5; document.getElementById('countdown-num').innerText = c;
    let int = setInterval(() => { 
        c--; 
        if(c > 0) { document.getElementById('countdown-num').innerText = c; playClockTick(c % 2 === 0); } 
        else { 
            clearInterval(int); overlay.classList.add('slide-up-out'); 
            setTimeout(() => { overlay.style.display='none'; if(!isMusicMuted) startGameMusic(); startGame(); }, 600); 
        } 
     }, 1000);
}

function startGame() {
    score = 0; document.getElementById('score').innerText = "0";
    document.getElementById('game-top-bar').style.visibility = 'visible';
    document.getElementById('game-bottom-bar').style.visibility = 'visible';
    document.getElementById('timer').style.visibility = (currentMode === 'hardcore' ? 'hidden' : 'visible');
    
    map.eachLayer(function(layer) { map.removeLayer(layer); });
    if(currentMode === 'blind_shot') { 
        if(profileData.mapStyle === 'Karanlƒ±k Harita') darkBlindLayer.addTo(map);
        else blindLayer.addTo(map);
        timeLeft = 180;
    } 
    else { 
        if(profileData.mapStyle === 'Karanlƒ±k Harita') darkLayer.addTo(map);
        else baseLayer.addTo(map); 
    }
    startRound(true);
}

function startRound(first = false) {
    if(score >= 25000) { showFinalScreen(); return; }
    if(guessMarker) map.removeLayer(guessMarker);
    if(realMarker) map.removeLayer(realMarker); if(line) map.removeLayer(line);
    guessMarker = null; document.getElementById("guessBtn").classList.remove("active");
    document.getElementById("distanceBox").style.display="none"; document.getElementById("guessBtn").style.display="block";
    if(currentMode === 'speedrun' && first) timeLeft = 60;
    else if(currentMode === 'normal') timeLeft = 120;
    let pool = Math.random() < 0.5 ? citiesEasy : citiesHard; selectedCity = pool[Math.floor(Math.random()*pool.length)];
    document.getElementById("cityName").innerText = selectedCity[0];
    roundActive = true; updateTimerUI();
    clearInterval(timerInterval);
    if(currentMode !== 'hardcore') { timerInterval = setInterval(() => { timeLeft--; updateTimerUI(); if(timeLeft<=0) gameOver("s√ºre doldu!"); }, 1000); }
}

function updateTimerUI() { let m = Math.floor(timeLeft/60), s = timeLeft%60; document.getElementById("timer").innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

map.on('click', (e) => { 
    if(!roundActive) return; 
    if(guessMarker) map.removeLayer(guessMarker); 
    guessMarker = L.marker(e.latlng).addTo(map); 
    document.getElementById("guessBtn").classList.add("active"); 

    if (e.latlng.lat <= -60) unlockAchievement('penguin');
});

function makeGuess() {
    if(!roundActive || !guessMarker) return;
    roundActive = false; clearInterval(timerInterval);
    document.getElementById("guessBtn").style.display = "none";
    let realPos = L.latLng(selectedCity[1], selectedCity[2]);
    let guessPos = guessMarker.getLatLng();
    
    // KAƒûIT SESƒ∞ EFEKTƒ∞ (D√ºrb√ºn Sesi Yerine)
    playPaperSound();
    map.flyTo(guessPos, 8, { duration: 1.5 });
    
    setTimeout(() => {
        playWindSound(1.5);
        map.panTo(realPos, { animate: true, duration: 1.2 });
        setTimeout(() => {
            realMarker = L.marker(realPos).addTo(map);
            line = L.polyline([guessPos, realPos], {color: 'red', weight: 3}).addTo(map);
            let dist = Math.round(map.distance(guessPos, realPos) / 1000);
         
            if(currentMode === 'hardcore' && dist > 500) { gameOver(`hata payƒ±nƒ± a≈ütƒ±n! mesafe: ${dist} km`); return; }
            if(currentMode === 'speedrun' && dist <= 500) timeLeft = 60;
            let roundScore = Math.max(0, 5000 - (dist * 5));
            score += roundScore;
            document.getElementById("distanceBox").innerText = `${dist} km | +${roundScore} puan`;
         
            document.getElementById("distanceBox").style.display = "block";
 
            animateScoreWithOverlay(roundScore);
            
            // G√ñREV KANCALARI
            let cityCont = getContinent(selectedCity[0]);
            triggerQuest('w16');
            if(currentMode === 'hardcore') triggerQuest('w22');
            if(currentMode === 'blind_shot') triggerQuest('d22');
            
            if (roundScore === 5000) { triggerQuest('d2'); triggerQuest('w14'); triggerQuest('w27'); unlockAchievement('achv_mid_1'); }
            if (roundScore >= 4500 && cityCont === 'EU') triggerQuest('d3');
            if (roundScore >= 4000 && selectedCity[0] === 'Tokyo') triggerQuest('d7');
            if (roundScore >= 4500 && cityCont === 'SA') triggerQuest('d10');
            if (roundScore >= 4000 && cityCont === 'AS') triggerQuest('d15');
            if (roundScore >= 4000 && cityCont === 'NA') triggerQuest('d16');
            if (roundScore >= 4500 && cityCont === 'AF') triggerQuest('w20');
            if (roundScore >= 3000) triggerQuest('d14');
            if (currentMode === 'speedrun' && roundScore >= 4500) triggerQuest('w2');
            if (roundScore >= 4500) triggerQuest('w8');
            
            let qs = loadQuestState();
            if (currentMode === 'blind_shot' && roundScore >= 3000) {
                qs.d8Streak++;
                if(qs.d8Streak >= 3) triggerQuest('d8');
            } else { qs.d8Streak = 0; }
            
            if (roundScore >= 4500) {
                qs.w13Streak++;
                if(qs.w13Streak >= 10) triggerQuest('w13');
            } else { qs.w13Streak = 0; }

            if (roundScore >= 4000) {
                qs.d18Streak++;
                if(qs.d18Streak >= 2) triggerQuest('d18');
            } else { qs.d18Streak = 0; }
            
            if (roundScore >= 4500 && cityCont !== 'UNKNOWN') {
                qs.w9Continents[cityCont]++;
                // √á√∂kmeyi engellemek i√ßin doƒürudan quest trigger fonksiyonunu tek seferlik ilerletme mantƒ±ƒüƒ±yla √ßaƒüƒ±rdƒ±k.
                if (qs.w9Continents[cityCont] === 5) triggerQuest('w9', 1);
                if (qs.w9Continents[cityCont] === 10) triggerQuest('w26', 1);
                
                let anyContinent20 = Object.values(qs.w9Continents).some(c => c >= 20);
                if(anyContinent20) unlockAchievement('achv_mid_6');
            }
            saveQuestState(qs);
            if (roundScore >= 4500) {
                streak4500++;
                localStorage.setItem('weekWorldStreak4500', streak4500);
                if (streak4500 >= 3) unlockAchievement('unstoppable');
                if (streak4500 >= 5) unlockAchievement('achv_mid_2');
            } else { streak4500 = 0; localStorage.setItem('weekWorldStreak4500', streak4500); }

            if (roundScore === 5000) unlockAchievement('guess_5k');
            if (roundScore > 0) unlockAchievement('first_right');
            if (roundScore === 0) unlockAchievement('first_wrong');
            
            if(score >= 25000) setTimeout(showFinalScreen, 4000);
        }, 1300);
    }, 2000);
}

function animateScoreWithOverlay(addedScore) {
    const overlay = document.getElementById('score-animation-overlay');
    const mainScoreEl = document.getElementById('anim-main-score');
    const addedScoreEl = document.getElementById('anim-added-score');
    const topScoreEl = document.getElementById('score');

    let startScore = score - addedScore;
    let endScore = score;

    overlay.style.display = 'flex';
    mainScoreEl.innerText = startScore;
    addedScoreEl.innerText = "+" + addedScore;

    // 1. Yazƒ±lar ekrana pop-up efektiyle gelir
    setTimeout(() => {
        mainScoreEl.classList.add('active');
        addedScoreEl.classList.add('active');
        playScoreTick(); // ƒ∞lk belirdiƒüindeki pop sesi
    }, 50);

    // 2. Pop-up bittikten sonra sayƒ±lar hƒ±zlƒ±ca artmaya ba≈ülar
    setTimeout(() => {
        let duration = 800; // Sayma animasyonu s√ºresi (ms)
        let startTimestamp = null;
        let lastTickTime = 0;

        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            
            // Sayƒ±yƒ± orantƒ±lƒ± olarak hesapla
            const currentScore = Math.floor(progress * (endScore - startScore) + startScore);
            mainScoreEl.innerText = currentScore;
            topScoreEl.innerText = currentScore;

            // Tƒ±k tƒ±k sayma sesi (her 60ms'de bir)
            if (timestamp - lastTickTime > 60 && progress < 1) {
                playClockTick(true);
                lastTickTime = timestamp;
            }

            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                mainScoreEl.innerText = endScore;
                topScoreEl.innerText = endScore;
                addedScoreEl.classList.remove('active');
            }
        };
        window.requestAnimationFrame(step);
    }, 600);

    // 3. Animasyon biter, ekran temizlenir ve mola ba≈ülar
    setTimeout(() => {
        mainScoreEl.classList.remove('active');
        overlay.style.display = 'none';
        
        if (score < 25000) {
            startMola();
        }
    }, 2200);
}

function startMola() {
    let molaTime = 5; let mBase = timeLeft;
    document.getElementById("timer").innerText = "mola: " + molaTime;
    clearInterval(nextRoundInterval);
    nextRoundInterval = setInterval(() => { 
        molaTime--; 
        document.getElementById("timer").innerText = "mola: " + molaTime; 
        if(molaTime >= 0) playClockTick(molaTime % 2 === 0);
        if(molaTime <= 0) { 
            clearInterval(nextRoundInterval); timeLeft = mBase; 
            const curtain = document.getElementById('transition-curtain'); curtain.classList.add('active'); 
           
             setTimeout(() => { map.setView([20,0], 3); startRound(); setTimeout(() => { curtain.classList.remove('active'); }, 200); }, 600); 
        } 
    }, 1000);
}

function gameOver(msg) { 
    gamesPlayed++; gamesLost++; saveStats(); 
    localStorage.setItem('weekWorldPendingXP', 75); // Kaybetse de XP veriyoruz
    clearInterval(timerInterval); clearInterval(nextRoundInterval); document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = `<h2>oyun bitti</h2><p>${msg}</p><button onclick=\"location.reload()\" style=\"padding:15px 30px; background:#ffcc00; border:none; border-radius:10px; font-weight:bold; color:black; cursor:pointer;\">lobiye d√∂n</button>`;
}

function showFinalScreen() { 
    gamesPlayed++; saveStats();
    const isCh = ['blind_shot', 'total_time'].includes(currentMode); 
    if(!isCh) { wins++; localStorage.setItem('weekWorldWins', wins); } 
    else { challengesCompleted++; saveStats(); addMedals(1); triggerQuest('d5', 1); triggerQuest('w10', 1); } 
    
    if(currentMode === 'blind_shot' && score >= 20000) unlockAchievement('blind_20k');
    if(currentMode === 'hardcore') unlockAchievement('hard_win');
    
    let hcWins = parseInt(localStorage.getItem('hc_wins')) || 0;
    if(currentMode === 'hardcore') { hcWins++; localStorage.setItem('hc_wins', hcWins); if(hcWins>=25) unlockAchievement('achv_mid_8'); }
    
    let srWins = parseInt(localStorage.getItem('sr_wins')) || 0;
    if(currentMode === 'speedrun') { srWins++; localStorage.setItem('sr_wins', srWins); if(srWins>=20) unlockAchievement('achv_mid_7'); }

    checkMilestoneAchievements();

    triggerQuest('d1'); triggerQuest('w11'); 
    if (score >= 20000) triggerQuest('w25');
    if (currentMode === 'hardcore') { triggerQuest('w1'); triggerQuest('d21'); }
    if (currentMode === 'blind_shot') triggerQuest('w3');
    if (currentMode === 'total_time' && timeLeft > 60) triggerQuest('w4');
    if (currentMode === 'total_time') triggerQuest('w28');
    if (profileData.mapStyle !== 'Varsayƒ±lan') triggerQuest('w6');
    if (currentMode === 'normal') { triggerQuest('w15'); triggerQuest('w17'); }
    if (currentMode === 'speedrun') triggerQuest('w21');
    if (isCh) { triggerQuest('d11'); triggerQuest('w30'); }

    let qs = loadQuestState();
    if (!qs.d9Modes.includes(currentMode)) {
        qs.d9Modes.push(currentMode);
        saveQuestState(qs);
        triggerQuest('d9'); 
    }

    // OYUN Bƒ∞Tƒ∞Mƒ∞ XP KAYDEDƒ∞LMESƒ∞
    localStorage.setItem('weekWorldPendingXP', 75);

    document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = `<h2 style="color:green">tebrikler!</h2><p>25.000 puan barajƒ±nƒ± ge√ßtin!</p><button onclick=\"location.reload()\" style=\"padding:15px 30px; background:#2962ff; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;\">lobiye d√∂n</button>`;
}

/* --- YENƒ∞ EKLENEN XP ANƒ∞MASYONU --- */
function processPendingXP() {
    let pendingXP = parseInt(localStorage.getItem('weekWorldPendingXP')) || 0;
    if (pendingXP > 0) {
        localStorage.removeItem('weekWorldPendingXP');
        setTimeout(() => playXPAnimation(pendingXP), 1000);
    }
}

function playXPAnimation(addedXP) {
    let container = document.getElementById('xp-anim-container');
    let text = document.getElementById('xp-anim-text');
    let fill = document.getElementById('xp-anim-bar-fill');
    let barText = document.getElementById('xp-anim-bar-text');
    
    let htmlStr = `+${addedXP} XP`.split('').map(char => `<span class="shatter-span" style="--tx:${Math.random()*200-100}px; --ty:${Math.random()*-200-50}px; --rot:${Math.random()*360-180}deg">${char===' '?'&nbsp;':char}</span>`).join('');
    text.innerHTML = htmlStr;
    let currentXP = parseInt(localStorage.getItem('weekWorldSeasonXP')) || 0;
    let currentTier = Math.floor(currentXP / 1000);
    let currentTierXP = currentXP % 1000;
    fill.style.width = (currentTierXP / 10) + '%';
    barText.innerText = `${currentTierXP} / 1000 XP`;
    // 1. Container ƒ∞√ßeri Kayar (1.5s)
    container.classList.add('show');
    playXPAnimSound('slide');
    setTimeout(() => {
        // 2. XP Sayƒ±sƒ± Pop-Up (1s)
        text.classList.add('pop');
        playXPAnimSound('pop');
        
        setTimeout(() => {
            // 3. Par√ßalanma ve Barƒ±n Dolmasƒ± (1.5s)
            document.querySelectorAll('.shatter-span').forEach(s => s.classList.add('shatter-active'));
            playXPAnimSound('shatter');
             
            let newXP = currentXP + addedXP;
            let newTierXP = newXP % 1000;
            
            if (Math.floor(newXP / 1000) > currentTier) {
                 fill.style.width = '100%';
            
                 barText.innerText = `1000 / 1000 XP`;
                 setTimeout(() => { 
                     fill.style.transition = 'none'; fill.style.width = '0%'; 
                     barText.innerText = `0 / 1000 XP`;
                 
                     setTimeout(() => { 
                         fill.style.transition = 'width 1.5s ease-in-out'; 
                         fill.style.width = (newTierXP/10) + '%';
                         barText.innerText = `${newTierXP} / 1000 XP`;
                     }, 50); 
                 }, 750);
            } else {
                 fill.style.width = (newTierXP / 10) + '%';
                 barText.innerText = `${newTierXP} / 1000 XP`;
            }
            localStorage.setItem('weekWorldSeasonXP', newXP);
            updateUI(); 
            
            setTimeout(() => {
                // 4. Container Dƒ±≈üarƒ± Kayar
                container.classList.remove('show');
                setTimeout(() => { text.classList.remove('pop'); text.innerHTML=''; }, 1500);
            }, 2500);
            // Kullanƒ±cƒ± ilerlemeyi izlesin diye bekleme s√ºresi
            
        }, 1500);
    }, 1500); 
}

/* --- 3D D√úNYA VE KURULUM --- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(40, 1, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(380, 380);
document.getElementById('world-3d-container').appendChild(renderer.domElement);
const globe = new THREE.Mesh(new THREE.SphereGeometry(2, 64, 64), new THREE.MeshPhongMaterial({ map: new THREE.TextureLoader().load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg') })); scene.add(globe);
const light = new THREE.DirectionalLight(0xffffff, 1.3); light.position.set(5,3,5); scene.add(light); scene.add(new THREE.AmbientLight(0x666666)); camera.position.z = 5.5;
let isDrg = false, prevM = {x:0, y:0}; document.getElementById('world-3d-container').onmousedown = () => isDrg = true;
window.onmouseup = () => isDrg = false; window.onmousemove = (e) => { if(isDrg) { globe.rotation.y += (e.clientX - prevM.x)*0.01;
globe.rotation.x += (e.clientY - prevM.y)*0.01; } prevM = {x:e.clientX, y:e.clientY}; };
function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); } animate(); updateUI();
updateQuestLogic(); enableDragScroll('.drag-area'); processPendingXP();

setInterval(() => { 
    totalSeconds++; 
    localStorage.setItem('weekWorldPlaytime', totalSeconds); 
    let d = Math.floor(totalSeconds / 86400), h = Math.floor((totalSeconds % 86400) / 3600), m = Math.floor((totalSeconds % 3600) / 60); 
    if(document.getElementById('playtime-display')) document.getElementById('playtime-display').innerText = `${d} g√ºn ${h} saat ${m} dakika`;
    if(totalSeconds >= 36000) unlockAchievement('loyal_10h');
    if(totalSeconds >= 72000) unlockAchievement('achv_mid_4');
    
    triggerQuest('d4', 1);
    triggerQuest('w7', 1);
    triggerQuest('w23', 1);
}, 1000);
</script>
</body>
</html>
