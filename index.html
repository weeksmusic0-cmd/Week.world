<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Week.world - Pro Edition PC</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<style>
    body{margin:0;font-family:'Segoe UI',Arial;overflow:hidden; background: #000; color: white;}
    #map{height:100vh; width:100%; cursor:crosshair; background: #222; position: absolute; top:0; left:0; z-index: 1;}

    /* LOBÄ° ARKA PLANI */
    #main-menu, #challenge-menu {
        position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
        background: #050505; z-index: 9999;
        display: flex; justify-content: space-between; align-items: center;
        transition: opacity 0.5s ease;
    }
    #challenge-menu { display: none; flex-direction: column; justify-content: center; z-index: 10001; }

    /* MERKEZÄ° ALAN */
    .center-stage {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        display: flex; flex-direction: column; align-items: center; z-index: 10000;
    }

    .game-title {
        color: white; font-size: 4.5rem; margin: 0 0 10px 0;
        letter-spacing: -2px; text-shadow: 0 5px 20px rgba(0,0,0,0.8);
        pointer-events: none; user-select: none;
    }

    #world-3d-container { width: 380px; height: 380px; cursor: grab; }

    /* MENÃœ YAPILARI */
    .side-menu-left { display: flex; flex-direction: column; gap: 20px; margin-left: 50px; z-index: 10000; }
    .challenge-grid { display: flex; gap: 30px; margin-top: 40px; }

    .mode-card {
        width: 260px; height: 120px; background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 15px;
        cursor: pointer; position: relative; overflow: hidden;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .mode-card:hover { background: rgba(255, 255, 255, 0.08); border-color: #ffcc00; transform: translateY(-5px); }
    .mode-title { font-size: 1.1rem; font-weight: bold; text-align: center; padding: 0 10px; }
    .mode-desc {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; width: 85%; font-size: 0.85rem; color: #ffcc00;
        opacity: 0; transition: 0.3s; pointer-events: none;
    }
    .mode-card:hover .mode-title { opacity: 0; }
    .mode-card:hover .mode-desc { opacity: 1; }

    .challenge-info-text { color: #888; font-size: 0.9rem; margin-top: 5px; }

    /* SAÄ MENÃœ */
    .side-menu-right { position: absolute; top: 25px; right: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 10000; }
    .panel-box {
        background: rgba(20, 25, 35, 0.9); padding: 20px;
        border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px); width: 260px;
    }

    /* GERÄ° BUTONU */
    .back-btn {
        position: absolute; bottom: 40px; left: 40px;
        padding: 12px 30px; background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2); color: white;
        border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s;
    }
    .back-btn:hover { background: #ff3d00; border-color: #ff3d00; }

    /* OYUN Ä°Ã‡Ä° UI */
    .top-bar{ position:absolute;top:20px;left:0;width:100%; display:flex;justify-content:space-between;padding:0 30px;box-sizing:border-box;z-index:1000; pointer-events:none; visibility: hidden; }
    .city-box{background:#ffcc00;padding:12px 25px;border-radius:12px;font-weight:bold;pointer-events:auto; color:black; font-size: 20px;}
    .score-box{background:#00c853;color:white;padding:12px 25px;border-radius:12px;font-weight:bold;pointer-events:auto; min-width:140px; text-align:center;}
    .timer-box{ position:absolute;top:20px;left:50%;transform:translateX(-50%); background:#ff3d00;color:white;padding:12px 30px;border-radius:20px; font-size:22px;font-weight:bold;z-index:1000; min-width: 120px; text-align: center; visibility: hidden;}
    .distance-box{ position:absolute;top:85px;left:50%;transform:translateX(-50%); background:#2962ff;color:white;padding:10px 25px;border-radius:20px; font-weight:bold;z-index:1000;display:none; }
    .bottom-bar{ position:absolute;bottom:40px;left:50%;transform:translateX(-50%); z-index:1000; visibility: hidden;}
    
    /* GÃœNCELLENEN TAHMÄ°N BUTONU */
    button.guess-btn { 
        padding:16px 60px;font-size:20px;border:none;border-radius:40px; 
        background:#2962ff;color:white;cursor:pointer;font-weight:bold; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        transition: all 0.3s ease;
        opacity: 0.4; pointer-events: none; /* VarsayÄ±lan: YarÄ± saydam ve tÄ±klanamaz */
    }
    button.guess-btn.active {
        opacity: 1; pointer-events: auto; /* Aktif: Normal ve tÄ±klanabilir */
    }

    .result-box{ position:fixed;top:50%;left:50%;transform:translate(-50%,-50%); background:white;padding:40px;border-radius:24px; z-index:10001; display:none; text-align:center; width:400px; color: black; box-shadow: 0 0 50px rgba(0,0,0,0.5);}

    /* RANK & MEDAL */
    .rank-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .win-bar { height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; display: flex; gap: 2px; padding: 2px; }
    .tick { flex: 1; background: rgba(255, 255, 255, 0.1); border-radius: 2px; }
    .tick.active { background: #ffcc00; box-shadow: 0 0 5px #ffcc00;}
</style>
</head>
<body>

<div id="main-menu">
    <div class="side-menu-left">
        <div class="mode-card" onclick="startGame('normal')">
            <span class="mode-title">ğŸŒ DÃœNYA MODU</span>
            <span class="mode-desc">Klasik deneyim. Hedef 25.000 puan.</span>
        </div>
        <div class="mode-card" onclick="startGame('speedrun')">
            <span class="mode-title">â±ï¸ SÃœRELÄ° MOD</span>
            <span class="mode-desc">DoÄŸru bilirsen sÃ¼re 1 dakikaya sÄ±fÄ±rlanÄ±r!</span>
        </div>
        <div class="mode-card" onclick="startGame('hardcore')">
            <span class="mode-title">ğŸ§­ ZOR MOD</span>
            <span class="mode-desc">Hata payÄ± yok (500km sÄ±nÄ±r).</span>
        </div>
        <div class="mode-card" onclick="openChallenges()">
            <span class="mode-title">ğŸ“š MEYDAN OKUMALAR</span>
            <span class="mode-desc">Meydan okuma kazandÄ±kÃ§a madalya kazanÄ±rsÄ±nÄ±z ve galibiyet sayÄ±nÄ±z artar.</span>
        </div>
    </div>

    <div class="center-stage">
        <h1 class="game-title">Week.world</h1>
        <div id="world-3d-container"></div>
    </div>

    <div class="side-menu-right">
        <div class="panel-box" id="rank-container">
            <div class="rank-header">
                <div id="rank-emoji" style="font-size:36px;">â›“ï¸</div>
                <div>
                    <div style="font-size: 10px; color: #888;">RANK</div>
                    <div id="rank-name" style="font-weight: bold;">Demir</div>
                </div>
            </div>
            <div class="win-bar" id="win-ticks"></div>
        </div>
        <div class="panel-box">
            <div style="font-size: 10px; color: #888;">TOPLAM OYNAMA SÃœRESÄ°</div>
            <div id="playtime-display" style="font-size: 15px; font-weight: bold; color: #ffcc00; margin-top: 5px;">0 GÃ¼n 0 Saat 0 Dakika</div>
        </div>
    </div>
</div>

<div id="challenge-menu">
    <div style="text-align: center;">
        <h2 style="font-size: 3rem; margin-bottom: 5px;">Mevcut Meydan Okumalar</h2>
        <div class="challenge-info-text">(meydan okuma yaptÄ±kÃ§a madalya kazanÄ±rsÄ±nÄ±z)</div>
    </div>

    <div class="challenge-grid">
        <div class="mode-card" onclick="startGame('total_time')">
            <span class="mode-title">â³ TOPLAM SÃœRE</span>
            <span class="mode-desc">25.000 puan iÃ§in toplam 5 dakikan var!</span>
        </div>
        <div class="mode-card" onclick="startGame('blind_shot')">
            <span class="mode-title">ğŸŒ‘ KÃ–R ATIÅ</span>
            <span class="mode-desc">SÄ±nÄ±rsÄ±z harita, 500km sÄ±nÄ±r ve 3 dakika sÃ¼re!</span>
        </div>
    </div>

    <div class="side-menu-right">
        <div class="panel-box">
            <div class="rank-header">
                <div style="font-size:36px;">ğŸ†</div>
                <div>
                    <div style="font-size: 10px; color: #888;">MADALYALAR</div>
                    <div id="medal-count" style="font-weight: bold; font-size: 24px;">0</div>
                </div>
            </div>
        </div>
    </div>

    <button class="back-btn" onclick="closeChallenges()">â† GERÄ°</button>
</div>

<div class="top-bar" id="game-top-bar">
    <div class="city-box">Hedef: <span id="cityName">Åehir</span></div>
    <div class="score-box">Puan: <span id="score">0</span></div>
</div>
<div class="timer-box" id="timer">02:00</div>
<div class="distance-box" id="distanceBox"></div>
<div class="bottom-bar" id="game-bottom-bar">
    <button class="guess-btn" id="guessBtn" onclick="makeGuess()">TAHMÄ°N ET</button>
</div>
<div class="result-box" id="result"></div>
<div id="map"></div>

<script>
/* 1. 3D DÃœNYA */
const container = document.getElementById('world-3d-container');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(40, 1, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(380, 380); 
container.appendChild(renderer.domElement);
const globeGeometry = new THREE.SphereGeometry(2, 64, 64);
const globeTexture = new THREE.TextureLoader().load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg');
const globeMaterial = new THREE.MeshPhongMaterial({ map: globeTexture, shininess: 35, specular: new THREE.Color(0x444444) });
const globe = new THREE.Mesh(globeGeometry, globeMaterial);
scene.add(globe);
const light = new THREE.DirectionalLight(0xffffff, 1.3);
light.position.set(5, 3, 5);
scene.add(light);
scene.add(new THREE.AmbientLight(0x666666));
camera.position.z = 5.5;

let isDragging = false;
container.onmousedown = () => isDragging = true;
window.onmouseup = () => isDragging = false;
window.onmousemove = (e) => { if (isDragging) { globe.rotation.y += e.movementX * 0.007; globe.rotation.x += e.movementY * 0.007; } };
function animateWorld() { requestAnimationFrame(animateWorld); renderer.render(scene, camera); }
animateWorld();

/* 2. OYUN MANTIÄI */
var citiesEasy = [
    ["Ä°stanbul", 41.00, 28.97], ["Ankara", 39.93, 32.85], ["Ä°zmir", 38.41, 27.12], ["Antalya", 36.89, 30.71],
    ["Londra", 51.50, -0.12], ["Paris", 48.85, 2.35], ["Berlin", 52.52, 13.40], ["Roma", 41.90, 12.49],
    ["Madrid", 40.41, -3.70], ["Atina", 37.98, 23.72], ["Moskova", 55.75, 37.61], ["Amsterdam", 52.36, 4.89],
    ["Tokyo", 35.67, 139.65], ["Pekin", 39.90, 116.40], ["Seul", 37.56, 126.97], ["Dubai", 25.20, 55.27],
    ["New York", 40.71, -74.00], ["Los Angeles", 34.05, -118.24], ["Rio de Janeiro", -22.90, -43.17], ["Sidney", -33.86, 151.20],
    ["BakÃ¼", 40.40, 49.86], ["Kahire", 30.04, 31.23], ["Viyana", 48.20, 16.37], ["BrÃ¼ksel", 50.85, 4.35],
    ["Lizbon", 38.72, -9.13], ["Meksika City", 19.43, -99.13], ["Toronto", 43.65, -79.38], ["Bangkok", 13.75, 100.50],
    ["Buenos Aires", -34.60, -58.38], ["Yeni Delhi", 28.61, 77.20]
];

var citiesHard = [
    ["Ulan Batur", 47.88, 106.89], ["Reykjavik", 64.12, -21.82], ["Astana", 51.16, 71.47], ["Lagos", 6.52, 3.37],
    ["Santiago", -33.44, -70.67], ["KinÅŸasa", -4.44, 15.26], ["Hanoi", 21.02, 105.83], ["Bogota", 4.71, -74.07],
    ["Addis Ababa", 9.03, 38.74], ["Lima", -12.04, -77.04], ["TaÅŸkent", 41.29, 69.24], ["AlmatÄ±", 43.22, 76.85],
    ["Nuuk", 64.18, -51.72], ["Tiflis", 41.71, 44.78], ["Erivan", 40.17, 44.51], ["Hartum", 15.50, 32.55],
    ["DarÃ¼sselam", -6.79, 39.20], ["KaraÃ§i", 24.86, 67.00], ["Manila", 14.59, 120.98], ["Cakarta", -6.20, 106.81],
    ["Perth", -31.95, 115.86], ["Auckland", -36.84, 174.76], ["Kazablanka", 33.57, -7.58], ["Dakar", 14.71, -17.46],
    ["Nairobi", -1.29, 36.82], ["Ä°slamabad", 33.68, 73.04], ["Katmandu", 27.71, 85.32], ["Muskat", 23.58, 58.40],
    ["Amman", 31.94, 35.92], ["Belgrad", 44.78, 20.44], ["Bratislava", 48.14, 17.10], ["Ljubljana", 46.05, 14.50],
    ["Tiran", 41.32, 19.81], ["ÃœskÃ¼p", 41.99, 21.43]
];

var map = L.map('map', {zoomControl: false, attributionControl: false, worldCopyJump: true}).setView([20,0], 3);
var baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
var blindLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png');

var selectedCity, lastCityName="", guessMarker=null, realMarker=null, line=null;
var score=0, wins=parseInt(localStorage.getItem('weekWorldWins'))||0, medals=parseInt(localStorage.getItem('weekWorldMedals'))||0, totalSeconds=parseInt(localStorage.getItem('weekWorldPlaytime'))||0;
var timerInterval, nextRoundInterval, timeLeft=120, roundActive=false, currentMode='normal', lastGuessDist=0;

// Oynama SÃ¼resi
setInterval(() => {
    totalSeconds++; 
    localStorage.setItem('weekWorldPlaytime', totalSeconds);
    let d = Math.floor(totalSeconds / 86400), h = Math.floor((totalSeconds % 86400) / 3600), m = Math.floor((totalSeconds % 3600) / 60);
    document.getElementById('playtime-display').innerText = `${d} GÃ¼n ${h} Saat ${m} Dakika`;
}, 1000);

function openChallenges() { document.getElementById('challenge-menu').style.display = 'flex'; setTimeout(() => document.getElementById('challenge-menu').style.opacity = '1', 10); }
function closeChallenges() { document.getElementById('challenge-menu').style.opacity = '0'; setTimeout(() => document.getElementById('challenge-menu').style.display = 'none', 500); }

function updateRankUI() {
    const ticksContainer = document.getElementById('win-ticks');
    const nameDiv = document.getElementById('rank-name');
    const emojiDiv = document.getElementById('rank-emoji');
    let emoji, name;
    if (wins < 20) { emoji = "â›“ï¸"; name = "Demir"; }
    else if (wins < 40) { emoji = "ğŸ¥ˆ"; name = "GÃ¼mÃ¼ÅŸ"; }
    else if (wins < 60) { emoji = "ğŸ¥‡"; name = "AltÄ±n"; }
    else if (wins < 80) { emoji = "ğŸ’"; name = "Elmas"; }
    else { emoji = "ğŸ‘‘"; name = "Efsane"; }
    emojiDiv.innerText = emoji; nameDiv.innerText = name;
    ticksContainer.innerHTML = '';
    for (let i = 0; i < 20; i++) {
        const tick = document.createElement('div');
        tick.className = 'tick' + (i < (wins % 20) ? ' active' : '');
        ticksContainer.appendChild(tick);
    }
    document.getElementById('medal-count').innerText = medals;
}

function startGame(mode) {
    currentMode = mode;
    score = 0;
    document.getElementById("score").innerText = "0";
    document.getElementById('main-menu').style.opacity = '0';
    document.getElementById('challenge-menu').style.opacity = '0';
    
    if(mode === 'blind_shot') { map.removeLayer(baseLayer); blindLayer.addTo(map); }
    else { map.removeLayer(blindLayer); baseLayer.addTo(map); }

    if(mode === 'total_time') { timeLeft = 300; } 

    setTimeout(() => {
        document.getElementById('main-menu').style.visibility = 'hidden';
        document.getElementById('challenge-menu').style.display = 'none';
        document.getElementById('game-top-bar').style.visibility = 'visible';
        document.getElementById('game-bottom-bar').style.visibility = 'visible';
        map.invalidateSize();
        startRound(true);
    }, 500);
}

function startRound(firstRound = false) {
    if(score >= 25000) { showFinalScreen(); return; }
    
    // UI SÄ±fÄ±rlama
    if(guessMarker) map.removeLayer(guessMarker);
    if(realMarker) map.removeLayer(realMarker);
    if(line) map.removeLayer(line);
    
    guessMarker = null; // Marker'Ä± temizle
    document.getElementById("guessBtn").classList.remove("active"); // Butonu deaktif yap
    
    document.getElementById("distanceBox").style.display="none";
    document.getElementById("guessBtn").style.display="block";
    document.getElementById("timer").style.visibility = (currentMode === 'hardcore') ? "hidden" : "visible";

    if (currentMode === 'speedrun') { if (firstRound || lastGuessDist <= 500) timeLeft = 60; }
    else if (currentMode === 'blind_shot') { timeLeft = 180; }
    else if (currentMode === 'normal') { timeLeft = 120; }

    // --- DENGELEYÄ°CÄ° SEÃ‡Ä°M SÄ°STEMÄ° ---
    let pool = Math.random() < 0.5 ? citiesEasy : citiesHard;
    let index;
    do { 
        index = Math.floor(Math.random() * pool.length); 
    } while(pool[index][0] === lastCityName);
    
    selectedCity = pool[index];
    lastCityName = selectedCity[0];

    document.getElementById("cityName").innerText = selectedCity[0];
    roundActive = true;
    updateTimerUI();
    
    clearInterval(timerInterval);
    if(currentMode !== 'hardcore') {
        timerInterval = setInterval(() => {
            timeLeft--; updateTimerUI();
            if(timeLeft<=0) { clearInterval(timerInterval); gameOver("SÃ¼re Doldu!"); }
        }, 1000);
    }
}

function updateTimerUI() {
    let m = Math.floor(timeLeft/60), s = timeLeft%60;
    document.getElementById("timer").innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// HARÄ°TA TIKLAMA OLAYI - BUTON AKTÄ°FLEÅTÄ°RME BURADA
map.on('click', function(e) { 
    if(!roundActive) return; 
    if(guessMarker) map.removeLayer(guessMarker); 
    guessMarker = L.marker(e.latlng).addTo(map);
    
    // Ä°ÅŸaretleme yapÄ±ldÄ±ÄŸÄ± an butonu parlat ve tÄ±klanabilir yap
    document.getElementById("guessBtn").classList.add("active");
});

function makeGuess() {
    if(!roundActive || !guessMarker) return;
    roundActive = false;
    clearInterval(timerInterval);
    document.getElementById("guessBtn").style.display = "none";
    document.getElementById("guessBtn").classList.remove("active");
    
    let realPos = L.latLng(selectedCity[1], selectedCity[2]);
    let guessPos = guessMarker.getLatLng();
    realMarker = L.marker(realPos).addTo(map);
    line = L.polyline([guessPos, realPos], {color: 'red', weight: 3}).addTo(map);
    lastGuessDist = Math.round(map.distance(guessPos, realPos) / 1000);

    if((currentMode === 'hardcore' || currentMode === 'blind_shot') && lastGuessDist > 500) { 
        gameOver(currentMode === 'blind_shot' ? "500km sÄ±nÄ±rÄ±nÄ± aÅŸtÄ±n! KÃ¶r atÄ±ÅŸ baÅŸarÄ±sÄ±z." : "500km sÄ±nÄ±rÄ± aÅŸÄ±ldÄ±!"); 
        return; 
    }
    
    let roundScore = Math.max(0, 5000 - (lastGuessDist * 5));
    score += roundScore;
    document.getElementById("score").innerText = score;
    document.getElementById("distanceBox").innerText = `${lastGuessDist} km mesafe | +${roundScore} Puan`;
    document.getElementById("distanceBox").style.display = "block";
    
    if(score >= 25000) setTimeout(showFinalScreen, 1500);
    else startCountdown();
}

function startCountdown() {
    let waitTime = 5;
    let originalTime = timeLeft; 
    document.getElementById("timer").innerText = "Mola: " + waitTime;
    clearInterval(nextRoundInterval);
    nextRoundInterval = setInterval(() => {
        waitTime--;
        document.getElementById("timer").innerText = "Mola: " + waitTime;
        if(waitTime <= 0) {
            clearInterval(nextRoundInterval);
            if(currentMode === 'total_time') timeLeft = originalTime; 
            startRound(false);
        }
    }, 1000);
}

function gameOver(msg) {
    clearInterval(timerInterval);
    document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = `<h2>OYUN BÄ°TTÄ°</h2><p>${msg}</p><button onclick="location.reload()" style="padding:15px 30px; cursor:pointer; background:#ffcc00; border:none; border-radius:10px; font-weight:bold;">LOBÄ°YE DÃ–N</button>`;
}

function showFinalScreen() {
    wins++; 
    localStorage.setItem('weekWorldWins', wins);
    
    if(currentMode === 'blind_shot' || currentMode === 'total_time') {
        medals++;
        localStorage.setItem('weekWorldMedals', medals);
    }

    document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = `<h2 style="color:green">TEBRÄ°KLER!</h2><p>25.000 Puan BarajÄ±nÄ± GeÃ§tin! Galibiyet ve Madalya KazandÄ±n.</p><button onclick="location.reload()" style="padding:15px 30px; cursor:pointer; background:#2962ff; color:white; border:none; border-radius:10px; font-weight:bold;">LOBÄ°YE DÃ–N</button>`;
}

updateRankUI();
</script>
</body>
</html>
